'use strict';var trup,init,lfgs,sycl,cfgo,uris,clip,dast,perm,blak,scbr,exts,down;
Registry.require("promise statistics convert xmlhttprequest downloads cache storage uri compat parser layout helper syncinfo notify asker i18n native".split(" "),function(){var n=Registry.log,q=rea.FEATURES,ga=function(){var e=[],c=!0,g=function(e,d,b){var a={title:e.join("\n\n")};d.path=rea.extension.getURL("images/icon"+(d.frag?"_"+d.frag:"")+".png");n.warn(e.join("\n"));rea.browserAction.setIcon({path:d.path});rea.browserAction.setTitle(a);d=function(a,b,d){a={name:"1",sub_menu_item:!0,pos:"left",
items:[]};a.items.push({name:e[0],image:"info"});1<e.length&&a.items.push({name:e[1]});d({items:[a],options:{enabled:!1}})};b||rea.extension.onMessage.addListener(d)};return{run:function(){try{Registry.verify("5349").length&&(c=!1,g(["Tampermonkey detected that browser is caching some outdated code parts.","In order to avoid unexpected behavior TM will be kept paused until your browser was restarted."],{frag:"paused"}))}catch(d){c=!1,n.error(d.message)}if("chromeStorage"==q.DB.USE&&!q.DB.NO_WARNING){var e=
function(){if(!r)return window.setTimeout(e,2E3);r.isWorking().fail(function(){confirm("Tampermonkey detected that the extension storage is unreliable!\n\nUnfortunately this means that all your settings and userscripts are inaccessible at the moment.\n\nDo you want to visit the FAQ entry that explains how to recover from that?")&&rea.tabs.create({url:"http://tampermonkey.net/faq#Q206"},function(){});g(["Tampermonkey detected that the extension storage is unreliable!"],{frag:"paused"},!0)})};window.setTimeout(e,
1E3)}return c},pause:g,setWarning:function(c,d,b){e.push({text:c,description:d,url:b})},getWarnings:function(){return e}}}();if(ga.run()){var m=Registry.get("promise"),x=Registry.get("helper"),J=Registry.get("cache"),K=Registry.get("statistics"),r=Registry.get("storage"),P=Registry.get("notify"),ba=Registry.get("asker"),L=Registry.get("native"),za=Registry.get("permission"),ra=Registry.get("layout"),B=Registry.get("uri"),c=Registry.get("i18n"),I=Registry.get("downloads");uris=B;down=I;perm=za;dast=
r;var sa=x.createUUID(),M={},V={};n.debug("Starting background fred @"+sa);J.create("rundata").setOptions({timeout:180,check_interval:120,retimeout_on_get:!0}).init();J.create("regexp").setOptions({timeout:3600,check_interval:120,retimeout_on_get:!0}).init();var Ba=function(){var e=m(),c,g,k=rea.extension.manifest.version,d=r.getSchemaVersion(),b=d;r.getVersion("0.0.0.0").then(function(a){g=a;c=y.versionCmp(k,g)==y.versionCmp.eNEWER;return r.isWiped()}).then(function(a){!c&&a&&(a=["Tampermonkey detected inconsistencies that indicate that your browser wiped the extension database!",
"You can continue to use Tampermonkey normally, but your settings and scripts might be lost. Click here to get more information.","http://tampermonkey.net/faq.php#Q207"],n.warn(a.join("\n")),ga.setWarning.apply(this,a))}).always(function(){var a=[],f=0,l=function(){if(f<a.length){var d=a[f].schema;a[f].cond(d)?a[f].fn().done(function(){d&&(n.log("Converted database from",b,"to",d),b=d);f++;l()}).fail(function(){e.reject()}):(f++,l())}},p=function(){n.warn("Incognito mode detected. Database conversion can only be done in non-incognito mode! Stopping now...");
ga.pause(["Tampermonkey needs to convert its database but this can't be done in incogonito mode!","Please open a non-incognito mode window and/or restart your browser."],{frag:"paused"})},a=[{cond:function(){return c&&!q.RUNTIME.FIREFOX&&!q.RUNTIME.EDGE&&"chromeStorage"==q.DB.USE&&!r.getValue(q.CONSTANTS.STORAGE.LEGACY_VERSION)&&y.versionCmp("3.5.3603",g)==y.versionCmp.eNEWER},fn:function(){var a=m();rea.extension.inIncognitoContext?(p(),a.reject()):(n.log("Update database..."),b="3.5.3603",r.migrate("sql",
"chromeStorage").done(function(){n.log("Copied config for default usage of chrome storage");a.resolve()}));return a.promise()}},{cond:function(){return c&&y.versionCmp("3.6.3650",b)==y.versionCmp.eNEWER&&y.versionCmp("3.5.3650",g)==y.versionCmp.eNEWER},fn:function(){var a=m();if(rea.extension.inIncognitoContext)p(),a.reject();else{b="3.6.3650";var f=[];[{o:"TM_config",n:q.CONSTANTS.STORAGE.CONFIG},{o:"TM_update_check",n:q.CONSTANTS.STORAGE.UPDATE},{o:"TM_version"},{o:"TM_unload_ts"}].forEach(function(a){if(a.n){var b=
r.getValue(a.o);void 0!==b&&f.push(r.setValue(a.n,b))}f.push(r.deleteValue(a.o))});var d=/@re$/,l=[];r.listValues().forEach(function(a){-1!=a.search(d)&&(a=a.replace(d,""),l.push(a))});l.forEach(function(a){var b=r.getValue(a+"@st"),d=r.getValue(a),l=r.getValue(a+"@re"),p=r.getValue(a+"@source"),e=A.getUidByName(a)||x.createUUID();f.push(r.deleteValue(a+"@st"));f.push(r.deleteValue(a));f.push(r.deleteValue(a+"@re"));f.push(r.deleteValue(a+"@source"));d&&l&&p?(f.push(r.setValue(q.CONSTANTS.PREFIX.SCRIPT_UID+
e,a)),f.push(r.setValue(q.CONSTANTS.PREFIX.COND+e,l)),f.push(r.setValue(q.CONSTANTS.PREFIX.STORE+e,b)),f.push(r.setValue(q.CONSTANTS.PREFIX.SCRIPT+e,p)),f.push(r.setValue(q.CONSTANTS.PREFIX.META+e,d))):n.warn("invalid script entry",{source:p,meta:d,cond:l})});d=/@st$/;r.listValues().forEach(function(a){-1!=a.search(d)&&f.push(r.deleteValue(a))});m.when(f).done(function(){n.log("Converted database from",g,"to",b);a.resolve()})}return a.promise()}},{schema:"3.7.0",cond:function(a){return y.versionCmp(a,
b)==y.versionCmp.eNEWER},fn:function(){var a=m();if(rea.extension.inIncognitoContext)p(),a.reject();else{var b=[],f=new RegExp("^"+q.CONSTANTS.PREFIX.META);r.listValues().forEach(function(a){if(-1!=a.search(f)){var d=r.getValue(a);d.options&&d.options.override&&!d.options.override.orig_run_at&&(d.options.override.orig_run_at=d.options.run_at||"document-idle",d.options.run_at=null,b.push(r.setValue(a,d)))}});m.when(b).done(function(){a.resolve()})}return a.promise()}},{schema:"4258",cond:function(a){return y.versionCmp(a,
b)==y.versionCmp.eNEWER},fn:function(){var a=m();if(rea.extension.inIncognitoContext)p(),a.reject();else{var b=r.getValue(q.CONSTANTS.STORAGE.CONFIG);b&&b.sync_enabled&&2==b.sync_type&&(b.sync_version=1,r.setValue(q.CONSTANTS.STORAGE.CONFIG,b));a.resolve()}return a.promise()}},{schema:"4526",cond:function(a){return c&&q.RUNTIME.SAFARI&&"chromeStorage"==q.DB.USE&&y.versionCmp(a,b)==y.versionCmp.eNEWER},fn:function(){var a=m();if(rea.extension.inIncognitoContext)p(),a.reject();else{n.log("Update database...");
var b=r.migrate("localStorage","chromeStorage").done(function(){n.log("Copied config for default usage of setting storage")});a.consume(b)}return a.promise()}},{schema:"4871",cond:function(a){return c&&y.versionCmp(a,b)==y.versionCmp.eNEWER},fn:function(){var a=m(),b,f,d=r.getValue(q.CONSTANTS.STORAGE.CONFIG);d&&d.scriptTemplate&&(f=h.getDefaults())&&(b=f.script_templates)&&b[0]&&b[0].value&&(b[0].value=d.scriptTemplate,delete d.scriptTemplate,r.setValue(q.CONSTANTS.STORAGE.CONFIG,d));a.resolve();
return a.promise()}},{cond:function(){return c||y.versionCmp(b,d)==y.versionCmp.eNEWER},fn:function(){var a=m();r.setVersion(k,b).done(function(){a.resolve()});return a.promise()}},{cond:function(){return c},fn:function(){n.log("First run of version "+k+"!");Aa.scheduleNotification(g,"0.0.0.0"==g);return m.Pledge()}},{cond:function(){return!0},fn:function(){var a=m();e.resolve();window.setTimeout(a.resolve,q.MISC.TIMEOUT);return a.promise()}}];l()});return e.promise()},da=function(){return{get:function(e,
c){var g=(0==e)+"#"+c,k=J.items.rundata.getj(g);if(k)k=k.oldret;else{var k=[],d=0,b={};if(c)for(var a=v.determineScriptsToRun(c),f=0;f<a.length;f++){var l=a[f];l.enabled?l.evilness&&l.evilness>=h.values.script_blacklist_severity||0!=e&&(!0===l.options.noframes||null===l.options.noframes&&!0===l.options.override.orig_noframes)||v.isContexter(l)||(b[l.name]=!0,k.push(l)):d++}k={runners:k,disabled:d,script_map:b};c&&J.items.rundata.setj(g,{frameId:e,oldret:k})}return k},answer:function(e,c){var g=x.select(e,
function(a){return a}),k=[{m:"native",t:[I.staticVars.DEFAULT,I.staticVars.NATIVE]},{m:"disabled",t:[I.staticVars.OFF]},{m:"browser",t:[I.staticVars.CHROME]}].filter(function(a){if(-1!=a.t.indexOf(h.values.downloads_mode))return!0}).map(function(a){return a.m})[0]||"disabled",d=rea.extension.inIncognitoContext,b=!d&&"off"!=h.values.external_connect&&v.validUrl(c,ta.externally_connectable_reg);return{scripts:g,contexters:ha.getContexterCount(),raw:{},external_connect:b,inIncognitoContext:d,downloadMode:k,
enforce_strict_mode:"on"==h.values.runtime_strict_mode,measure_scripts:h.values.debug,logLevel:h.values.logLevel,version:rea.extension.manifest.version}},getContexters:function(e,c){for(var g=[],k=v.determineScriptsToRun(c),d=0;d<k.length;d++){var b=k[d];b.enabled&&(0==e||!0!==b.options.noframes&&(null!==b.options.noframes||!0!==b.options.override.orig_noframes))&&v.isContexter(b)&&g.push(b)}return g}}}(),C=function(){var e={},c=1,g=c++,k=c++,d=c++,b=c++,a=c++,f=c++,l=c++,p=function(){var a={frames:{0:{state:g}},
tabs:{reset_ts:Date.now()},scripts:{},urls:{},maps:{},contexts:{onUnload:{}},stats:{running:0,disabled:0},extra:{}};Object.defineProperties(a.urls,{length:{value:0,enumerable:!1,writable:!0,configurable:!0}});return a},z={updateStats:function(a,b,f,d){e[a].stats.running+=f;e[a].stats.disabled+=d;e[a].contexts.onUnload[b]=e[a].contexts.onUnload[b]||[];e[a].contexts.onUnload[b].push(function(){e[a].stats.running-=f;e[a].stats.disabled-=d});e[a].tabs.ts=Date.now()},updateMaps:function(a,b,f){var d=1,
l=function(b,f){void 0===e[a].maps[f]&&1===d&&(e[a].maps[f]=0);e[a].maps[f]+=d};x.each(f,l);e[a].contexts.onUnload[b]=e[a].contexts.onUnload[b]||[];e[a].contexts.onUnload[b].push(function(){e[a]&&(d=-1,x.each(f,l))})},updateUrls:function(a,b,f){var d=function(d){1===d&&(void 0===e[a].urls[f]?e[a].urls[f]={frameId:b,count:0}:0===b&&(e[a].urls[f].frameId=b));e[a].urls[f].count+=d;e[a].urls.length=-1};d(1);e[a].contexts.onUnload[b]=e[a].contexts.onUnload[b]||[];e[a].contexts.onUnload[b].push(function(){e[a]&&
d(-1)})},determine:function(a,b,f){var d=null;W.isAllowed(f)?d=f:(n.debug("This URL is filtered by the security settings:",f,"-> Do nothing!"),C.set.forbidden(a,b));b=da.get(b,d);e[a].scripts[f]=b;return b.runners.length},run:function(a,b,f,d,l){a=[];for(b=0;b<d.length;b++)a.push(ua.bundle({url:f},d[b]));var p;m.when(a).always(function(a){l?l(a):p=a});return p}},u={},t={},ca={},O={},F={listeners:{once:{whenReady:function(a,b){if(!e[a]||e[a].frames[0].state<d)F.listeners.once.onReady(a,b);else b()},
onReady:function(a,b){var f=function(a){F.listeners.remove.onCommited(d);F.listeners.remove.onCompleted(l);a&&b()},d=F.listeners.add.onCommited(function(b){b===a&&f(!0)}),l=F.listeners.add.onCompleted(function(b){b===a&&f(!0)})}},add:{onReset:function(a){var b=x.createUUID();u[b]=a;return b},onCommited:function(a){var b=x.createUUID();t[b]=a;return b},onCompleted:function(a){var b=x.createUUID();ca[b]=a;return b},onRemoved:function(a){var b=x.createUUID();O[b]=a;return b}},remove:function(){return{onReset:function(a){delete u[a]},
onCommited:function(a){delete t[a]},onCompleted:function(a){delete ca[a]},onRemoved:function(a){delete O[a]}}}()},events:{reset:function(a,b){e[a]=p();e[a].frames[0].state=g;x.each(u,function(f){f&&f(a,b)})},response:function(a,b,f){if(h.values.enabled){e[a]=e[a]||p();e[a].frames[b]=e[a].frames[b]||{};var d=e[a].frames[b].state||g;0===b&&(e[a].tabs.response_ts=Date.now());f=B.woHash(f);d<k&&(z.determine(a,b,f),e[a].frames[b].state=k);return(a=e[a].scripts[f])?a.runners.length:0}},commited:function(a,
b,f){if(h.values.enabled){var l=B.parse(f);if("http:"===l.protocol||"https:"===l.protocol||"file:"===l.protocol)e[a]=e[a]||p(),e[a].frames[b]=e[a].frames[b]||{},l=e[a].frames[b].state||g,l>=d||(e[a].frames[b].state=d,l<k&&(f=B.woHash(f),z.determine(a,b,f)),x.each(t,function(b){b&&b(a)}))}},loading:function(a,f,d){if(h.values.enabled){var l=B.parse(d);"http:"!==l.protocol&&"https:"!==l.protocol&&"file:"!==l.protocol||0!==f||"file:"!==l.protocol||(e[a]=e[a]||p(),e[a].frames[f]=e[a].frames[f]||{},l=
e[a].frames[f].state||g,l>=b||(e[a].frames[f].state=b,l<k&&(d=B.woHash(d),z.determine(a,f,d))))}},run:function(b,f,d,l,c){if(h.values.enabled){var t=0===f||q.RUNTIME.EXEC_SCRIPT_SUPPORT||q.RUNTIME.FAST_EXEC_SUPPORT?f:d;e[b]=e[b]||p();e[b].frames[t]=e[b].frames[t]||{};if(q.RUNTIME.FAST_EXEC_SUPPORT&&e[b].frames[t].exec)c&&c();else{var g=B.woHash(l),k=e[b].scripts[g];if(!k&&(n.debug("tv: lazy init @ events.run("+b+", "+f+", "+d+", "+l+")"),z.determine(b,f,g),k=e[b].scripts[g],!k)){n.warn("tv: no script run info for tab "+
b+" @ "+g,n.D?e[b].scripts:"");return}d=e[b].frames[t].state;e[b].frames[t].state=a;d!=a&&(z.updateMaps(b,t,k.script_map),z.updateUrls(b,t,g),z.updateStats(b,t,k.runners.length,k.disabled));return z.run(b,f,g,k.runners,c?function(a){F.events.exec(b,t,l);c(a)}:null)}}},exec:function(a,b,f){h.values.enabled&&e[a]&&(f=B.woHash(f),delete e[a].scripts[f],e[a].frames[b]&&(e[a].frames[b].exec=!0))},complete:function(b,d,l){l=B.parse(l);if(h.values.enabled&&("http:"===l.protocol||"https:"===l.protocol||"file:"===
l.protocol)){if(0===d){e[b]=e[b]||p();e[b].frames[d]=e[b].frames[d]||{};var t=e[b].frames[d].state||g;e[b].frames[d].state=f;if(!C.get.empty(b)&&C.get.stats(b).running){if(t<a){n.warn("tv: no script run info!");return}"file:"===l.protocol?window.setTimeout(function(){rea.tabs.sendMessage(b,{method:"onLoad",frameId:d},function(){})},500):rea.tabs.sendMessage(b,{method:"onLoad",frameId:d},function(){})}}x.each(ca,function(a){a&&a(b)})}},unload:function(a,b,f){b=0===b||q.RUNTIME.EXEC_SCRIPT_SUPPORT||
q.RUNTIME.FAST_EXEC_SUPPORT?b:f;e[a]=e[a]||p();e[a].frames[b]=e[a].frames[b]||{};e[a].frames[b].state=l;if(e[a]&&e[a].contexts.onUnload[b]){for(f=0;f<e[a].contexts.onUnload[b].length;f++)e[a].contexts.onUnload[b][f]();e[a].contexts.onUnload[b]=[]}},remove:function(a){delete e[a];x.each(O,function(b){b&&b(a)})}},set:{extra:function(a,b,f,d){e[a]=e[a]||p();null===b?e[a].extra[f]=d:(e[a].extra[f]=e[a].extra[f]||{},e[a].extra[f][b]=d)},blocker:function(a){F.set.extra(a,null,"blocker",!0)},forbidden:function(a,
b){0===b&&F.set.extra(a,null,"forbidden",!0)}},get:{extra:function(a,b,f,d){void 0===d&&(d=null);var l=null,l=(e[a]?e[a].extra:{})[f];null!==b&&l&&(l=l[b]);return l||d},empty:function(a){var b=!0;if(e[a]&&0!=e[a].urls.length){if(-1==e[a].urls.length)return e[a].urls.length=0,x.each(e[a].urls,function(b,f){"length"!==f&&0<b.count&&e[a].urls.length++}),F.get.empty(a);b=!1}return b},urls:function(a){return e[a]?e[a].urls:{}},stats:function(a,b){var f={};if(e[a]&&(f.running=e[a].stats.running,f.disabled=
e[a].stats.disabled,b)){f.unique=0;for(var d in e[a].maps)e[a].maps.hasOwnProperty(d)&&0<e[a].maps[d]&&f.unique++}return f},tabs:function(){var a={};x.each(e,function(b,f){a[f]={ts:b.response_ts}});return a},blocker:function(a){return F.get.extra(a,null,"blocker")},forbidden:function(a){return F.get.extra(a,null,"forbidden")},exec:function(a,b){return e[a]&&e[a].frames[b]&&e[a].frames[b].exec}}};return F}(),ka=function(){return{isScriptUrl:function(e){if(!e||-1!=e.search(/\#bypass=true/)||-1!=e.search(q.REQUESTS.GET_INTERNAL_PAGE_REGEXP())||
"data:"===e.substr(0,5))return!1;e=e.split(/[\?#$]/)[0];var c=-1!=e.search(/.+\.user\.(js\#|js\?|js$)/)||-1!=e.search(/.+\.tamper\.(js\#|js\?|js$)/);return c?!(-1!=e.search(/^htt[ps]{1,2}:\/\/code\.google\.com/)||-1!=e.search(/^htt[ps]{1,2}:\/\/github\.com/)&&!v.determineOriginOfUrl(e)):c}}}(),va=function(){var e=function(e){var c=m(),k=Date.now();e.url+=-1!=e.url.search("\\?")?"&":"?";e.url+="ts="+k;var k=function(a){if(4==a.readyState&&(200==a.status||0==a.status))if("arraybuffer"==d.responseType){if(a.response){c.resolve({decoded:!0,
encoding:e.encoding,content:G.arrbuf2str(a.response,e.encoding)});return}}else if(null!==a.response&&void 0!==a.response){c.resolve({decoded:!0,encoding:e.encoding,content:a.response});return}c.reject({content:""})},d={method:"GET",retries:0,responseType:"arraybuffer",url:e.url};if(e.sync){var b=S(d,{});4==b.readyState&&0==b.status&&b.error&&(delete d.responseType,b=S(d,{}));k(b)}else S(d,{ondone:k});return c.promise()};return{getSource:function(c){"string"===typeof c&&(c={url:c});return e(c)}}}();
lfgs=va;var W=function(){return{init:function(){var e=function(){J.items.regexp.remove("PageFilter")};h.addChangeListener("forbiddenPages",e);h.addChangeListener("page_whitelist",e);h.addChangeListener("page_filter_mode",e)},isAllowed:function(e){var c=!1,g=!1,k=0!=h.values.forbiddenPages.length,d=0!=h.values.page_whitelist.length;switch(h.values.page_filter_mode){case "black":g=k;break;case "off":break;case "white":c=d;break;default:c=d,g=k}(k=J.items.regexp.get("PageFilter"))||(k=v.regexify({inc:c?
h.values.page_whitelist:void 0,exc:g?h.values.forbiddenPages:void 0}),J.items.regexp.set("PageFilter",k));return!g&&!c||v.validUrl(e,k)}}}(),Q=function(){var e=function(e,c){var d=!1;if(c.length)return(d="/"==c.substr(0,1)?v.matchUrl(e,v.convertToRegExp(c)):-1!=e.search(c))&&n.debug('black: entry "'+c+'" matched'),d},w={init:function(){var e=m(),c=function(){"server"===h.values.script_blacklist_type&&window.setTimeout(w.checkUpdate,2E4)};c();h.addChangeListener("script_blacklist_type",c);e.resolve();
return e.promise()},getWarningsFor:function(g){var k=[];g&&x.each(h.values.script_blacklist_server,function(d){if(d){var b=c.getUiLocale(),a;x.each(d.rules,function(b){a|=e(g,b);return 1!=a});a&&(d.reasons?k.push(d.reasons[b]||d.reasons.en):d.reason&&k.push(d.reason))}});return k},getEvilnessOf:function(c){if("off"===h.values.script_blacklist_type)return!1;if(!c)return 0;var k=!1,d=0;x.each(h.values.require_blacklist,function(b){k|=e(c,b);return 1!=k});k?d=11:"server"===h.values.script_blacklist_type&&
x.each(h.values.script_blacklist_server,function(b){if(b&&(x.each(b.rules,function(a){k|=e(c,a);return 1!=k}),k))return d=b.severity,!1});return Number(d)},checkUpdate:function(e){var c=m(),d=X.getConfig(),b;if(e||6048E5<Date.now()-d.black.last){var a=function(a,b){var d=m();S({method:"GET",url:a,nocache:b,retries:q.XMLHTTPREQUEST.RETRIES,overrideMimeType:"text/plain; charset=x-user-defined"},{ondone:function(a){d.resolve(a)}});return d.promise()};a("https://blacklist.tampermonkey.net/get.php?version=get").then(function(f){if(4==
f.readyState&&200==f.status){try{b=JSON.parse(f.responseText).version}catch(l){n.warn("black: unable to parse version response! "+f.responseText)}n.info("black: local version: "+d.black.version+" remote: "+b);if(b>d.black.version||e)return a("https://blacklist.tampermonkey.net/get.php",!0)}}).then(function(a){if(a&&4==a.readyState&&200==a.status)try{var b=JSON.parse(a.responseText);b&&b.blacklist&&1==b.version&&(h.values.script_blacklist_server=b.blacklist);n.info("black: updated blacklist to ",b)}catch(d){n.warn("black: blacklist update failed! ",
a.responseText)}}).always(function(){d=X.getConfig();d.black.last=Date.now();d.black.version=b||d.black.version;X.setConfig(d);c.resolve()})}else c.resolve();return c.promise()}};return w}();blak=Q;var Ca=function(){for(var e=[],c=[],g=0;g<e.length;g++){var k=Registry.getRaw("system/"+e[g]+".tamper.js");k&&c.push(k)}return c},H=function(){var e=0,w=[],g={to:null,force:null,t:0},k={},d=function(a){n.debug("sync: import",a.uuid,a.name,a.url);var b={imported:h.values.sync_type},f={},d;for(d in u.SYNCED)!0===
u.SYNCED[d]&&(f[d]=a.options[d]);return v.installFromUrl(a.url,{uuid:a.uuid,ask:!1,internal:!0,sync:b,force_options:f},{silent_fail:!0})},b=function(a){n.debug("sync: export",a.name,a.url);return E.add(a)},a=function(a){var b=a.downloadURL?a.downloadURL.split("#")[0]:null,f=a.fileURL?a.fileURL.split("#")[0]:null,d=x.select([f,b],function(a){if(!a||"file:"!==B.parse(a).protocol)return a})[0],b={uuid:a.uuid,name:a.name,options:{},durl:b,furl:f,url:d},l;for(l in u.SYNCED)!0===u.SYNCED[l]&&null!==a.options[l]&&
(b.options[l]=a.options[l]);return b},f=function(){var b=[];A.getUidList().forEach(function(f){f=A.getByUid(f);f.script&&f.cond&&b.push(a(f.script))});return b},l=function(a){if(u.enabled)if(0<e)a&&u.addSyncDoneCallback(function(b){b&&u.sync(50,a)});else{e++;var l=null,p=null,g=!0,z={},q=function(a){if(a){(a=a.split("#")[0])&&(a=a.toLowerCase());for(var b=0;b<l.length;b++){var f=l[b].furl?l[b].furl.toLowerCase():null,d=l[b].durl?l[b].durl.toLowerCase():null;if(f==a||d==a)return l[b]}}return null},
r=function(a){if(a)for(var b=0;b<p.length;b++)if(p[b].uuid==a)return p[b];return null},x=function(a){if(a){a=a.split("#")[0];for(var b=0;b<p.length;b++)if(p[b].url==a)return p[b]}return null},y=function(a){if(!a)return null;for(var b=0;b<l.length;b++)if(l[b].uuid==a)return l[b]};(function(){l=f();return E.list().done(function(a){p=a}).fail(function(){n.warn("sync: unable to get remotelist!")})})().then(function(){for(var a=m(),b=[],f=0;f<p.length;f++)b.push(function(){var a,b=p[f],l=!1,e=!1,t=2==
h.values.sync_version?y(b.uuid):q(b.url);if(t)if(l=!0,z[b.url]=!0,b.uuid&&(z[b.uuid]=!0),b.content&&G.MD5(b.content)!=G.MD5(t.textContent))e=!0;else for(a in u.SYNCED)if(!0===u.SYNCED[a]&&t.options[a]!=b.options[a]){e=!0;break}if(l)if(b.options.removed)n.debug("sync: remove local script",b.uuid,b.name,b.url),v.doRemove(t.uuid,!1);else if(e)if(n.debug("sync: update local script",b.uuid,b.name,b.url),e=A.getByUid(t.uuid),e.script&&e.cond){for(a in u.SYNCED)!0===u.SYNCED[a]&&(e.script.options[a]=b.options[a]);
b.content&&(e.script.textContent=b.content);v.doModify(e.script.uuid,e.script,!1)}else n.warn(c.getMessage("fatal_error")+"("+t.name+")!!!");if(!l&&!b.options.removed)if(a=m(),k[b.url]||b.uuid&&k[b.uuid])n.warn("sync: skip previously failed import",b);else return d(b).done(function(a){a||(n.warn("sync: unable to import",b),k[b.url]=!0,b.uuid&&(k[b.uuid]=!0))}).fail(function(){n.warn("sync: unable to load",b);k[b.url]=!0;b.uuid&&(k[b.uuid]=!0)}).always(a.resolve),a.promise();return m.Pledge()}());
m.when(b).done(function(){a.resolve()});return a.promise()}).then(function(){l=f();return m.Pledge()}).then(function(){if(!E.isWritable())return m.Pledge();for(var a=m(),f=[],d=0;d<l.length;d++)f.push(function(){var a=l[d],f=!1;if(!a.url||z[a.url]||z[a.uuid])return m.Pledge();if(2==h.values.sync_version?r(a.uuid):x(a.url))f=!0;return f?m.Pledge():b(a).done(function(a){})}());m.when(f).done(function(){a.resolve()});return a.promise()}).fail(function(){g=!1}).done(function(){g=!0}).always(function(){n.debug("sync: finished");
if(0==--e)for(var a=g;w.length;)w.shift()(a)})}},p=function(){u.enabled&&u.sync(500,!0)},z=null,u={enabled:!1,SYNCED:{comment:!0},createTeslaData:function(){for(var a=m(),b=[],d=f(),l=0;l<d.length;l++)if(d[l].url){var e=JSON.stringify(d[l].options),e=d[l].name.replace(/\|/g,"!")+"|"+e+"|"+d[l].url.replace(/\|/g,"%7C");b.push(e)}a.resolve(b);return a.promise()},configChangeListener:function(){z||(z=window.setTimeout(function(){z=null;u.init().done(function(){u.enabled&&u.sync(3E3)})},3E3))},init:function(){var a=
m();u.enabled=!1;(function(){return h.values.sync_enabled&&h.values.sync_type?E.init(h.values.sync_type,h.values.sync_version,h.values.sync_id).done(function(a){u.enabled=a;u.enabled?E.addChangeListener(p):n.warn("sync: init failed!")}):m.Pledge()})().always(function(){a.resolve(u.enabled)});return a.promise()},finalize:function(){},reset:function(){return E.reset()},addSyncDoneCallback:function(a){w.push(a)},sync:function(a,b){var f=Date.now();a=a||500;b=g.force||b;g.to?(window.clearTimeout(g.to),
g.ts<f+a&&(a=g.ts-f,1>a&&(a=1))):n.debug("sync: schedule sync for run in "+a+" ms");g.force=b;g.ts=f+a;g.to=window.setTimeout(function(){l(g.force);g.to=null;g.force=null},a)},scriptAddedCb:function(f,d){if(u.enabled&&E.isWritable()){var l=a(d);l.url&&B.parse(l.url).protocol.match(/https?:/)&&b(l)}},scriptChangedCb:function(f,d,l){if(u.enabled&&E.isWritable()&&(f=a(d),f.url))for(var e in u.SYNCED)if(!0===u.SYNCED[e]&&d.options[e]!=l.options[e]){b(f);break}},scriptRemovedCb:function(b,f){if(u.enabled&&
E.isWritable()){var d=a(f);d.url&&(n.debug("sync: remove",d.name,d.url),E.remove(d))}}};return u}();sycl=H;var Da=function(){h.addChangeListener("sync_enabled",H.configChangeListener);h.addChangeListener("sync_type",H.configChangeListener);h.addChangeListener("sync_id",H.configChangeListener);h.addChangeListener("sync_version",H.configChangeListener);h.addChangeListener("logLevel",function(){n.set(h.values.logLevel)});h.addChangeListener("i18n",function(){c.setLocale(h.values.i18n)});h.addChangeListener("native_import_path",
function(){L.setPath(h.values.native_import_path)});h.addChangeListener("incognito_mode",function(){wa()});h.addChangeListener("statistics_enabled",function(){K.setEnabled(h.values.statistics_enabled)});h.addChangeListener("require_blacklist",v.blackCheckAll);h.addChangeListener("script_blacklist_server",v.blackCheckAll);h.addChangeListener("script_blacklist_type",v.blackCheckAll);h.addChangeListener("downloads_extension_whitelist",I.config_changed_listener);h.addChangeListener("downloads_mode",I.config_changed_listener);
h.addChangeListener("webrequest_modHeaders",function(e,c,g,k){k.done(window.setTimeout(T.reset,1))})},h=function(){var e={},c={enabled:!0,configMode:0,debug:!1,logLevel:0,showFixedSrc:!1,webrequest_modHeaders:"yes",webrequest_fixCSP:"yes",notification_showUpdate:"changelog",notification_silentScriptUpdate:!0,script_templates:[{name:"ECMAScript 5",value:"// ==UserScript==\n// @name         New Userscript\n// @namespace    http://tampermonkey.net/\n// @version      0.1\n// @description  try to take over the world!\n// @author       You\n// @match        <$URL$>\n// @grant        none\n// ==/UserScript==\n\n(function() {\n    'use strict';\n\n    // Your code here...\n})();"},
{name:"ECMAScript 6",value:"// ==UserScript==\n// @name         New ES6-Userscript\n// @namespace    http://tampermonkey.net/\n// @version      0.1\n// @description  shows how to use babel compiler\n// @author       You\n// @require      https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.6.15/browser-polyfill.min.js\n// @require      https://cdnjs.cloudflare.com/ajax/libs/babel-core/5.6.15/browser.min.js\n// @match        <$URL$>\n// ==/UserScript==\n\n/* jshint ignore:start */\nvar inline_src = (<><![CDATA[\n/* jshint ignore:end */\n/* jshint esnext: true */\n\n// Your code here...\n\n/* jshint ignore:start */\n]]\x3e</>).toString();\nvar c = babel.transform(inline_src);\neval(c.code);\n/* jshint ignore:end */"},
{name:"CoffeeScript",value:"// ==UserScript==\n// @name         New Coffee-Userscript\n// @namespace    http://tampermonkey.net/\n// @version      0.1\n// @description  shows how to use coffeescript compiler\n// @author       You\n// @require      http://coffeescript.org/extras/coffee-script.js\n// @match        <$URL$>\n// ==/UserScript==\n/* jshint ignore:start */\nvar inline_src = (<><![CDATA[\n\n// Your code here\n\n]]\x3e</>).toString();\nvar compiled = this.CoffeeScript.compile(inline_src);\neval(compiled);\n/* jshint ignore:end */"}],
scriptUpdateCheckPeriod:864E5,scriptUpdateHideNotificationAfter:15E3,scriptUpdateCheckDisabled:!1,scriptUrlDetection:"auto",runtime_strict_mode:"byscript",runtime_inject_mode:"default",runtime_inject_delay:10,autoReload:!1,appearance_badges:"running",appearance_badge_color:"gcal"===rea.runtime.short_id?"#444":"#ee3131",editor_enabled:!0,editor_fontSize:100,editor_theme:"default",editor_keyMap:"windows",editor_indentUnit:4,editor_indentWithTabs:!1,editor_tabMode:"indent",editor_electricChars:!0,editor_autoSave:!1,
editor_easySave:!0,editor_autoLint:!0,editor_autoLintMaxLen:5E4,editor_lineWrapping:!1,editor_highlightTrailingWhitespace:!0,native_import:!0,native_import_path:null,native_import_post_action:"disable",i18n:null,action_menu_columns:2<=q.ACTIONMENU.COLUMNS?2:1,action_menu_scripts_hide_disabled:!1,action_menu_scripts_sort:"position",incognito_mode:"temporary",layout:"default",sync_enabled:!1,sync_type:2,sync_version:2,sync_id:"",statistics_enabled:!0,downloads_mode:"default",downloads_extension_whitelist:"/^[^\\.]*$/ /\\.mp[34]$/ .wav /\\.(avi|mkv|flv|divx|mpe?g|webm)$/ /\\.(ico|gif|png|jpe?g)/ /\\.(srt|sub|idx)$/ .txt .iso .zip /\\.r(ar|[0-9]{2,2})$/".split(" "),
external_update_interval:6048E5,external_connect:"all",require_timeout:2E4,require_blacklist:["/^https?:\\/\\/example.com(:[0-9]{1,5})?\\/.*/"],require_sri_mode:"supported",script_blacklist_server:[],script_blacklist_type:"server",script_blacklist_severity:4,connect_mode:"ask",page_filter_mode:"black",page_whitelist:["/https?:\\/\\/greasyfork\\.org\\/.*/","http://xkcd.com/970/"],forbiddenPages:"*example.org/* *paypal.tld/* *stripe.com/* https://*deutsche-bank-24.tld/* https://*bankofamerica.tld/* /^.*:\\/\\/apis\\.google\\.com\\/((?!render)([^\\/]+)\\/)+([^\\/]+)?$/ *://www.facebook.com/plugins/* *://platform.twitter.com/widgets/*".split(" ")},
g=function(d,b){var a=r.getValue(q.CONSTANTS.STORAGE.CONFIG,{}),f=void 0===a[d]?c[d]:a[d];a[d]=b;var l=r.setValue(q.CONSTANTS.STORAGE.CONFIG,a);e[d]&&JSON.stringify(f)!=JSON.stringify(b)&&e[d].forEach(function(a){try{a(d,f,b,l)}catch(e){n.warn("config: changeListener error",e)}})},k={init:function(){var d=m();k.values={};k.__defineGetter__("snapshot",function(){return x.assign({},k.values)});for(var b in c)c.hasOwnProperty(b)&&function(){var a=b;k.values.__defineGetter__(a,function(){var b=r.getValue(q.CONSTANTS.STORAGE.CONFIG,
{});return void 0===b[a]?c[a]:b[a]});k.values.__defineSetter__(a,function(b){g(a,b)})}();k.initialized=!0;var a=Ca();Object.keys(a).forEach(function(b){var d=a[b];window.setTimeout(function(){v.doSave({url:null,src:d,ask:!1,replace:!0,internal:!0})},1)});d.resolve();return d.promise()},getDefaults:function(){return c},addChangeListener:function(d,b){e[d]||(e[d]=[]);e[d].push(b)}};return k}(),S=function(e,c){return ia(e,c,{internal:!0})},ea=function(){var e={},c=function(a){var b=a.split(".");if(3>
b.length||B.isIp(a))return a;a=B.isSecondLevelDomain(b.slice(-2).join("."))?-3:-2;return b.slice(a).join(".")},g=function(a){return a&&-1!=a.indexOf("*")},k=function(){var a=m();rea.tabs.getSelected(null,function(b){a.resolve(b)});return a.promise()},d=function(a){var b=m();W.isAllowed(a)?b.resolve({allowed:!0}):b.resolve({allowed:!1});return b.promise()},b=function(a,b){var f=function(a){return a?a.map(function(a){if(a.match(/^'?self'?$/))a=B.parse(b.url).hostname||null;else if("'none'"==a)a="none";
else if(-1===["none","localhost","*"].indexOf(a)&&(1>a.indexOf(".")||1===(a.match(/\./g)||[]).length&&B.isSecondLevelDomain(a)))return null;return a}):[]};return{connects:a.options.override.merge_connects&&"paranoid"!=h.values.connect_mode?f(a.connects):[],userconnects:f(a.options.override.use_connects),blockers:f(a.options.override.use_blockers)}},a=function(a,b,f){var d=m(),l=function(){d.resolve({permitted:!0})},c=function(a){d.resolve({permitted:!1,reason:a})},p=function(){d.resolve({unknown:!0})},
k,z=function(a,b){var f=null,d=B.isIp(a);b.every(function(b){if(b.a)for(var e=0;e<b.a.length;e++)if(b.a[e]&&(d?b.a[e]===a:-1!=a.search(new RegExp("(^|.+\\.)"+x.escapeForRegExp(b.a[e])+"$"))))return f=b.blocker?c:l,!1;return!0});return f};if("off"==h.values.connect_mode)l();else if((k=B.parse(f))&&k.hostname)if((f=z(k.hostname,[{a:e[a.uuid]}]))||(f=g(e[a.uuid])?l:null))f();else if(0===b.connects.length&&0===b.userconnects.length&&0===b.blockers.length)"casual"==h.values.connect_mode?l():"strict"==
h.values.connect_mode?c("No @connects given, but strict mode enabled"):p();else if(-1!=b.connects.indexOf("none"))c("None value found");else{if("casual"!=h.values.connect_mode||g(b.blockers)||!(f=g(b.connects)?l:null))(f=g(b.userconnects)?l:null)||(f=z(k.hostname,[{a:b.blockers,blocker:!0},{a:b.connects},{a:b.userconnects}])||p);f()}else c("URL can not be parsed");return d.promise()},f=function(){var a=function(a){for(var b=0;b<p.length;b++)if(p[b].tabId===a)return p.splice(b,1)[0];return p.pop()},
b;k().then(function(f){for(;!l&&(b=a(f.id));)b.fn()})},l,p=[],z=function(a,b,d,h,z){var u,q=m(),r=function(){q.resolve({approved:!0})},x=function(){q.resolve({forbidden:!0})};n.debug('cor: "'+a.name+'" is asking for permission to access',h,b);if((u=B.parse(h))&&u.hostname){var y=c(u.hostname),A=b.tab?b.tab.id:null;l=!0;k().then(function(f){return ba.askForConnect({src_url:b.url,hostname:u.hostname,domain:y,all_domains:g(d.connects),tabid:A,active:A===f.id,timeout:z,url:h,settings_url:rea.extension.getURL("options.html")+
"#nav="+a.uuid+"+settings",connect_url:"http://tampermonkey.net/documentation.php#_connect",script:{name:a.name,uuid:a.uuid,icon:a.icon64||a.icon||rea.extension.getURL("images/txt.png")}})}).done(function(b){var f,d=b.whole_domain?y:u.hostname;b.allow?b.once?(n.debug('cor: allowing "'+a.name+'" to access',d,"once"),r()):b.temporary?(n.debug('cor: allowing "'+a.name+'" to access',d,"temporarily"),void 0===e[a.uuid]&&(e[a.uuid]=[]),-1==e[a.uuid].indexOf(d)&&e[a.uuid].push(d),r()):(f=r,b.all_domains?
(n.debug('cor: allowing "'+a.name+'" to access all domains always'),a.options.override.use_connects.push("*")):(n.debug('cor: allowing "'+a.name+'" to access',d,"always"),a.options.override.use_connects.push(d),f=r)):b.once||b.aborted?(n.debug('cor: denying "'+a.name+'" to access',d,"once"),x()):(a.options.override.use_blockers||(a.options.override.use_blockers=[]),f=x,b.all_domains?(n.debug('cor: denying "'+a.name+'" to access any domains (additional) domain'),a.options.override.use_blockers.push("*")):
(n.debug('cor: denying "'+a.name+'" to access',d,"always"),a.options.override.use_blockers.push(d)));f&&v.doModify(a.uuid,a,!1).always(f)}).fail(x).always(function(){l=!1;p.length&&window.setTimeout(f,1)})}else x();return q.promise()},u=function(f,e,c,k){var w=b(f,e),q=arguments;return d(c).then(function(b){if(!0!==b.allowed)return m.Breach("URL is blacklisted");var d,l;return(d=B.parse(c))&&d.origin&&(l=B.parse(e.url))&&l.origin&&d.origin===l.origin?m.Pledge({permitted:!0}):a(f,w,c)}).then(function(a){if(!1===
a.permitted)return m.Breach("URL is not permitted"+(a.reason?": "+a.reason:""));if(!0===a.permitted)return m.Pledge();if(0===w.connects.length||g(w.connects)){if(-1==["ask","paranoid"].indexOf(h.values.connect_mode))return m.Breach();if(g(w.blockers))return m.Breach("URL was permanently blocked by the user");if(l){n.debug('cor: queuing access permission check from "'+f.name+'" to',c,e);var b=m();p.push({tabId:e.tab?e.tab.id:null,fn:function(){b.consume(u.apply(this,q))}});return b.promise()}return z(f,
e,w,c,k).then(function(a){return!0===a.approved?m.Pledge():m.Breach("Request was blocked by the user")})}return m.Breach("URL is not a part of the @connect list")})};return{getSessionConnects:function(a){return e[a]||[]},setSessionConnects:function(a,b){e[a]=b||[]},purgeAppeals:function(a){p=p.filter(function(b){return b.tabId!==a})},exec:function(a,b,f,d){var l,e,c,p,k=a.url,g=[],h=Math.max(Math.min(a.timeout||0,6E4),2E4),z=function(){for(var a;!c&&!p&&(a=g.shift());)a()},m=function(b,f){var l='Refused to connect to "'+
(f||a.url)+'": '+(b||"Blocked by @connect CORS check"),e=la.makeErrorResponse(l);["onerror","ondone"].forEach(function(a){if(d[a])d[a]({response:e,exception:l})})};if(!(f&&f.url&&f.tab&&a.url&&b&&(e=A.getByUid(b))&&e.script&&e.cond))return m();u(e.script,f,a.url,h).done(function(){var b={};Object.keys(d).forEach(function(a){b[a]=function(t){var w=arguments;c||(p?g.push(function(){b[a].apply(this,w)}):function(){return t&&t.finalUrl&&k!==t.finalUrl?(p=!0,u(e.script,f,t.finalUrl,h).fail(function(){c||
(l&&l.abort(),c=!0,m("Request was redirected to a not whitelisted URL",t.finalUrl),n.warn("cor: request to",k,"was redirect to a not whitelisted URL",t.finalUrl))}).always(function(){k=t.finalUrl;p=!1;g.length&&window.setTimeout(z,1)})):{always:function(a){a()}}}().always(function(){if(!c)d[a]({response:t})}))}});l=ia(a,b)}).fail(function(a){m(a);n.warn("cor: access to",k,"was denied")});return{abort:function(){c=!0;l&&l.abort()}}}}}(),ma=function(){var e=function(a){var b=[];a=new DataView(a);for(var d=
0;d<a.byteLength;d+=4){var e=("00000000"+a.getUint32(d).toString(16)).slice(-8);b.push(e)}return b.join("")},c={md5:function(a,b){return m.Pledge(G.MD5(a,b))}},g={};["SHA-1","SHA-256","SHA-384","SHA-512"].forEach(function(a){var b=a.toLowerCase().replace("-","");g[b]=function(){var b=function(b,f){var d=m();window.crypto.subtle.digest(a,G.str2arrbuf(b,f)).then(function(a){d.resolve(e(a))},function(){d.reject()});return d.promise()};try{return b("").then(function(a){if(a&&a.substr(0,4).toLowerCase().match(/[0-9a-f]{4,4}/))return b})}catch(f){return m.Breach()}}});
var k=function(a){return-1!=Object.keys(c).indexOf(a)},d=function(a){return function(){if(!1!==b){var f=arguments,d=m();b.push(function(){d.consume(a.apply(this,f))});return d.promise()}return a.apply(this,arguments)}},b=[];return{init:function(){n.D&&Object.keys(c).forEach(function(a){n.debug("sri:",a,"is supported")});return m.sidebyside(Object.keys(g).map(function(a){return g[a]().done(function(b){n.debug("sri:",a,"is supported");c[a]=b}).fail(function(){n.debug("sri:",a,"is unsupported")})})).always(function(){b.forEach(function(a){a()});
b=!1})},isSupported:d(function(a){return m.Pledge(k(a))}),getHash:d(function(a,b){var d=m();"string"===typeof a&&(a=B.parse(a));if(a&&a.hash){for(var c,g,h=a.hash.replace(/^#/,"").split(/,|;/g),t=0;t<h.length;t++)if((g=h[t].match(/([^=|:|-]+)[=|:|-](.+)/))&&3==g.length&&k(g[1])){c=g[2];if(!/^[0-9a-fA-F]+$/.exec(c)){var n;var w=decodeURIComponent(c);try{n=e(G.str2arrbuf(G.Base64.decode(w)))}catch(q){n=null}c=n||c}c={type:g[1],value:c}}d.resolve(c||(b?c:{type:"unsupported",value:""}))}else d.resolve();
return d.promise()}),check:d(function(a,b,d){return b&&a&&k(a.type)?c[a.type](b,d).then(function(b,f){return((f=b===a.value)?m.Pledge:m.Breach)(f||{type:a.type,value:b})}):m.Breach()})}}(),N=function(){var c={key:function(a,b){return q.CONSTANTS.PREFIX.EXTERNAL+x.select([a,b?G.MD5(b):null],function(a){return a}).join(":")},list:function(a){var b=new RegExp("^"+a);return x.select(r.listValues(),function(a){return-1!=a.search(b)})},set:function(a,b,d){a=c.key(a,b);var p={};x.each(d,function(a,b){"content"==
b&&(b="base",a=G.encodeS(a));p[b]=a});r.setValue(a,{ts:Date.now(),url:b,resource:p})},get:function(a,b){var d=c.key(a,b),d=r.getValue(d),p;if(d&&d.resource){var g={};x.each(d.resource,function(a,b){"base"==b&&(b="content",a=G.decodeS(a));g[b]=a});p={ts:d.ts,url:d.url,data:g}}return p},clean:function(a,b){var d=c.key(a,b);r.deleteValue(d)},cleanAll:function(a,b){var d,p=c.list(c.key(a));if(b){var g={};x.each(b,function(b){b=c.key(a,b);g[b]=!0});d=[];x.each(p,function(a){g[a]||d.push(a)})}else d=p;
d.forEach(function(a){r.deleteValue(a)})}},w=function(a,b){var d=m(),c={method:"GET",url:a,retries:q.XMLHTTPREQUEST.RETRIES,nocache:!1,responseType:b.via_arraybuffer?"arraybuffer":void 0},e=function(c){var e={content:""};if(4!=c.readyState||200!=c.status&&0!=c.status||c.error)d.reject(e);else{for(var p,g=c.responseHeaders?c.responseHeaders.split("\n"):[],k=0;k<g.length;k++){var h=g[k].split(":"),z=h.shift()||"",h=h.join(":")||"";if("content-type"==z.trim().toLowerCase()&&-1!=h.search("image")){p=
h.trim();break}}if(!p){var u;a.match(".*.(ico|jpg|jpeg)+($|\\?|#).*")?p="image/x-icon":(u=a.match(".*.(gif|png)+($|\\?|#).*"))?p="image/"+u[1]:-1!=a.search(".js")?p="text/javascript":(u=a.match(".*.(css|html|xml)+($|\\?|#).*"))?p="text/"+u[1]:x.isLocalImage(a)&&(p="image/x-icon")}e.meta=p;e.content=b.via_arraybuffer?G.arrbuf2str(c.response,b.encoding):c.responseText;d.resolve(e)}},g=function(){d.reject({})};b.sync?e(S(c,{})):(c.timeout=h.values.require_timeout,S(c,{onload:e,onerror:g,ontimeout:g}));
return d.promise()},g=x.getDebouncer(9E3),k=function(a,b,l){l.no_storage=!0;d(a,b,l).done(function(d){c.set(a,b,d.resource)}).fail(function(d){n.warn("externals: update.failed :(",a,b,d)}).always(function(){var d=c.get(a,b);d&&d.data?c.set(a,b,d.data):n.warn("externals: should never happen!")})},d=function(a,b,d){var p=m(),z=B.parse(b),u={sync:d.sync},t;ma.getHash(z,"supported"==h.values.require_sri_mode).done(function(m){if(b)if(Q.getEvilnessOf(b)>=h.values.script_blacklist_severity)u.resource={blacklisted:!0,
content:""},p.reject(u);else if("enforce"!=h.values.require_sri_mode||m)if(!d.no_storage&&"file:"!==z.protocol&&(t=c.get(a,b))){var O=c.key(a,b),F=Date.now();0<h.values.external_update_interval&&F-t.ts>h.values.external_update_interval&&!g.is(O)&&(1<h.values.external_update_interval&&g.add(O),n.debug("externals: resource needs update",b,(new Date(t.ts)).toISOString(),(new Date(F)).toISOString()),window.setTimeout(function(){k(a,b,d)},3E3));u.resource=t.data;u.resource.forbidden||u.resource.blacklisted?
p.reject(u):p.resolve(u)}else u.sync=!1,"file:"==z.protocol&&-1==b.search(q.REQUESTS.GET_INTERNAL_PATH_REGEXP(!0))?(q.RUNTIME.ALLOWS_FILE_SCHEME_ACCESS||n.warn("externals: Access to local files is forbidden! Loading the following @resource may fail:",b,"-> more info:","http://tampermonkey.net/faq.php#Q204"),O=va.getSource({url:b,encoding:d.encoding})):O=w(b,{via_arraybuffer:d.via_arraybuffer,encoding:d.encoding}),O.done(function(g){m&&(g.sri=m);var k=function(p){!d.no_storage&&z.protocol&&"file:"!==
z.protocol&&-1==b.search(q.REQUESTS.GET_INTERNAL_PATH_REGEXP(!0))&&c.set(a,b,p)};m&&-1!=["supported","given"].indexOf(h.values.require_sri_mode)?ma.check(m,g.content,d.encoding).done(function(){u.resource=g;k(u.resource);p.resolve(u)}).fail(function(a){u.resource={forbidden:!0,sri:{mode:h.values.require_sri_mode,type:m.type,value:"invalid"},determined:a,content:""};k(u.resource);p.reject(u)}):(u.resource=g,k(u.resource),p.resolve(u))}).fail(function(d){n.debug("externals: get.failed",a,b,d);u.resource=
{failed:!0,content:""};p.reject(u)});else u.resource={forbidden:!0,sri:{mode:h.values.require_sri_mode},content:""},p.reject(u);else u.resource={forbidden:!0,content:""},p.reject(u)});return p.promise()},b={getElement:function(a,b){return c.get(a,b)},cleanElement:function(a,b){return c.clean(a,b)},dropAll:function(a){c.cleanAll(a);return m.Pledge()},dropAllBut:function(a,b){c.cleanAll(a,b);return m.Pledge()},loadResources:function(a,d){var l=m();b.getResources(a,d).always(function(){l.resolve()});
return l.promise()},loadRequires:function(a,d){var l=m();b.getRequires(a,d).always(function(){l.resolve()});return l.promise()},getResources:function(a,b){var l={elements:[]},c=m(),e=[],g={via_arraybuffer:!0,sync:!0};b.forEach(function(b){var f=b.url||B.sanitize(b.unsafe_url,b.abs_url),c={name:b.name,url:f},f=d(a,f,g),p=m();f.done(function(a){a=a.resource;c.content=a.content;c.meta=a.meta||"application"}).fail(function(a){a.resource&&a.resource.forbidden?a.resource.sri?n.warn("externals: can't load @resource",
b.name,"from URL",b.unsafe_url,"due to a SRI error"):n.warn("externals: can't load @resource",b.name,"from forbidden URL",b.unsafe_url):a.resource&&a.resource.blacklisted?n.warn("externals: can't load @resource",b.name,"from blacklisted URL",b.unsafe_url):(n.warn("externals: can't load @resource",b.name,"from URL",b.unsafe_url),c.failed=!0);c.content=null}).always(function(a){g.sync&=a.sync;l.elements.push(c);p.resolve()});e.push(p)});m.when(e).always(function(){l.sync=g.sync;c.resolve(l)});return c.promise()},
getRequires:function(a,b){var l={elements:[]},c=m(),e=[],g={encoding:"UTF-8",sync:!0};x.each(b,function(b,f){var c=b.url||B.sanitize(b.unsafe_url,b.abs_url),p={},c=d(a,c,g),k=m();c.done(function(a){p.textContent=a.resource.content||""}).fail(function(a){a.resource&&a.resource.forbidden?a.resource.sri?(p.textContent="// this @require's (\""+encodeURIComponent(b.unsafe_url)+'") SRI check failed!\n',n.warn("externals: can't load @require from URL",b.unsafe_url,"due to a SRI error")):(p.textContent='// this @require ("'+
encodeURIComponent(b.unsafe_url)+'") is not allowed!\n',n.warn("externals: can't load @require from forbidden URL",b.unsafe_url)):a.resource&&a.resource.blacklisted?(p.textContent='// this @require ("'+encodeURIComponent(b.unsafe_url)+'") is blacklisted!\n',n.warn("externals: can't load @require from blacklisted URL",b.unsafe_url)):(p.textContent='// this @require ("'+encodeURIComponent(b.unsafe_url)+'") could not be loaded!\n',n.warn("externals: can't load @require from URL",b.unsafe_url))}).always(function(a){g.sync&=
a.sync;l.elements[f]=p;k.resolve()});e.push(k)});m.when(e).always(function(){l.sync=g.sync;l.elements=l.elements.filter(function(a){return a});c.resolve(l)});return c.promise()}};return b}();exts=N;var ua=function(){var c=function(c,e,d){var b=m(),a=[];d.forEach(function(b){b=b.textContent||"";b=ja.mkCompat(b,c.options.compatopts_for_requires?c:null,"off"!=h.values.runtime_strict_mode);a.push(b)});d="\n"+a.join("\n")+"\n";var f=A.getStorageByUid(c.uuid);e=ja.mkCompat(e,c,"off"!=h.values.runtime_strict_mode);
if(h.values.debug){e=e.split("\n");for(var l=!1,p,z=0;z<e.length;z++)if(p=e[z],!p.match(/^\s*$|^\s*\/\/\s*|^\s*\/\*.*\*\/\s*$|^\s*["']+use strict["']+;*\s*$/))if(p.match(/^\s*\/\*/)&&(l=!0),l)if(p.match(/\*\/\s*$/))l=!1;else{if(-1!=(p=p.search(/\*\//))){e[z]=x.insert(e[z],p+2,0,"debugger;");break}}else{e[z]="debugger;"+e[z];break}e=e.join("\n")}b.resolve({header:c.header,code:e,requires:d,storage:f,script:c});return b.promise()},w={};return{bundle:function(g,k){var d,b,a=!0;if(d=w[k.uuid])return d;
var f={},l="includes matches requires resources excludes connects textContent".split(" ");Object.keys(k).forEach(function(a){-1==l.indexOf(a)&&("options"==a?(f[a]=JSON.parse(JSON.stringify(k[a])),f[a].run_at=f[a].run_at||k.options.override.orig_run_at||"document-idle"):f[a]=k[a])});d=N.getResources(f.uuid,k.resources).then(function(b){a&&!b.sync&&(n.debug("ri: uncached @external detected -> fast script start disabled"),a=b.sync);f.resources=b.elements;return N.getRequires(f.uuid,k.requires)}).then(function(b){a&&
!b.sync&&(n.debug("ri: uncached @external detected -> fast script start disabled"),a=b.sync);b=b.elements;n.debug("run script "+f.name+" @ "+g.url);return c(f,k.textContent,b)}).always(function(){b=!0;delete w[f.uuid]});b||(w[f.uuid]=d);return d}}}(),xa=function(){var c=rea.extension.getViews({type:"popup"});c&&c.length&&rea.extension.sendMessage({method:"updateActions"},function(){})},X=function(){return{getConfig:function(){var c={version:0,last:0},h={scripts:0},g=r.getValue(q.CONSTANTS.STORAGE.UPDATE,
h);"object"!==typeof g&&(g=h);g||(g=h);void 0==g.black&&(g.black=c);void 0==g.scripts&&(g.scripts=0);return g},setConfig:function(c){c&&r.setValue(q.CONSTANTS.STORAGE.UPDATE,c)}}}(),Y=function(){var e=function(e,d){var b=0,a=0;if(e){var f=c.getMessage("Script_Update"),l=c.getMessage("Check_for_userscripts_updates")+"...";P.show(f,l,rea.extension.getURL("images/icon128.png"),1E4)}f=A.getUidList().map(function(f){var l,e,k,w,r,F;n.info("update: check for script updates @",f);return function(){w=A.getByUid(f);
if(!w.script||!w.cond)return n.warn("update: inconsistent script entry",f,w),m.Breach();var a=!h.values.scriptUpdateCheckDisabled&&!w.script.enabled&&!d;return d&&w.script.uuid!==d||a||!(F=v.determineSourceURL(w.script))?m.Breach():m.Pledge()}().then(function(){var a=v.determineMetaURL(w.script);if(!a)return m.Pledge();var b=m();ia({method:"GET",retries:q.XMLHTTPREQUEST.RETRIES,timeout:1E3*q.SCRIPT_DOWNLOAD.TIMEOUT,nocache:!0,headers:{Accept:"text/x-userscript-meta, */*"},url:a},{ondone:function(d){4==
d.readyState&&200==d.status?r=y.processMetaHeader(d.responseText):n.warn("update: unable to find meta data @ "+a+" req.status = "+d.status);b.resolve()}});return b.promise()}).then(function(){var a=!!r,b=a&&!!r.version,d=b&&(!w.script.version||y.versionCmp(r.version,w.script.version)==y.versionCmp.eNEWER);return a&&b&&!d?m.Breach():m.Pledge()}).then(function(){return g.getScriptFromURL(F).fail(function(){n.warn("update: failed",w.script.name,F)})}).then(function(a){var d;var f=w.script.uuid;d=y.createScriptFromSrc(a);
d=d.name&&""!=d.name&&void 0!==d.version?(f=A.getMetaByUid(f))&&f.system?null:d.options.compat_uW_gmonkey?y.versionCmp.eERROR:-1!=d.name.search("@")?y.versionCmp.eERROR:f&&d.version==f.version?y.versionCmp.eEQUAL:f&&y.versionCmp(d.version,f.version)==y.versionCmp.eOLDER?y.versionCmp.eOLDER:y.versionCmp.eNEWER:y.versionCmp.eERROR;return d==y.versionCmp.eNEWER?(b++,l=w.script.name,e=F,k=a,m.Pledge()):m.Breach()}).then(function(){if(h.values.notification_silentScriptUpdate)return m.Pledge();var a=c.getMessage("There_is_an_update_for_0name0_avaiable_",
l)+"\n"+c.getMessage("Click_here_to_install_it_"),b=c.getMessage("Just_another_service_provided_by_your_friendly_script_updater_")+":",d=m();P.show(b,a,rea.extension.getURL("images/icon128.png"),h.values.scriptUpdateHideNotificationAfter,d.resolve);return d.promise()}).then(function(b){var d=f||w.script.uuid;return void 0===b||b.clicked?v.doSave({url:e,uuid:d,replace:!d,src:k,ask:!h.values.notification_silentScriptUpdate}).done(function(b){b&&b.installed&&a++}):m.Breach()})});return m.sidebyside(f).then(function(){0==
b&&e&&(n.debug("No update found"),P.show("Narf!",c.getMessage("No_update_found__sry_"),rea.extension.getURL("images/icon128.png"),1E4));return{found:b,installed:a}})},w=null,g={check:function(g,d,b){if(!g&&0>=h.values.scriptUpdateCheckPeriod)return m.Breach();var a=X.getConfig();if(!g&&Date.now()-a.scripts<Math.max(h.values.scriptUpdateCheckPeriod,36E5))return m.Breach();var f=m();g=function(){l&&(window.clearTimeout(l),l=null);p&&p.cancel();e(d,b).done(function(a){f.resolve(a.installed)}).fail(function(){f.resolve(null)});
a=X.getConfig();a.scripts=Date.now();X.setConfig(a)};var l,p,z=function(){p=null;var a=c.getMessage("Script_Update"),b=c.getMessage("Waiting_for_sync_to_finish")+"...";p=P.show(a,b,rea.extension.getURL("images/icon128.png"),6E4)};H.enabled?(H.addSyncDoneCallback(g),H.sync(50,!1),d&&(l=window.setTimeout(z,500))):g();return f.promise()},getScriptFromURL:function(c){var d=m();S({method:"GET",retries:q.XMLHTTPREQUEST.RETRIES,timeout:1E3*q.SCRIPT_DOWNLOAD.TIMEOUT,nocache:!0,headers:{Accept:"text/x-userscript, */*"},
url:c},{onload:function(b){4!=b.readyState||200!=b.status&&0!=b.status||b.error?d.reject():d.resolve(b.responseText)},onerror:function(b){d.reject({error:!0,responseText:b.responseText})},ontimeout:function(){d.reject({timeout:!0,responseText:""})}});return d.promise()},init:function(){var c=function(){w&&(window.clearTimeout(w),w=null);0<h.values.scriptUpdateCheckPeriod&&(w=window.setTimeout(function(){w=null;g.check();c()},36E5))};c();h.addChangeListener("scriptUpdateCheckPeriod",c)}};return g}();
trup=Y;var v=function(){var e=function(b){b.sort(function(a,b){return a.position-b.position});return b},w=function(b){void 0===b.ask&&(b.ask=!0);if(void 0===b.url||null==b.url)b.url="";""===b.force_url&&(b.force_url=null);var a=y.createScriptFromSrc(b.src),f=null,l={heading:null,errors:[],info:[],warnings:[],flags:{}},e=m(),g=Date.now(),k=b.save&&!b.ask&&h.values.editor_easySave,t=b.uuid,w;a.name&&void 0!=a.version?w=m.Pledge():(l.errors.push(c.getMessage("Invalid_UserScript__Sry_")+"\n\n"),b.name&&
l.errors.push(c.getMessage("Script_name_0name0",b.name)+"\n\n"),b.url&&l.errors.push(c.getMessage("Downloaded_from_0url0",b.url)),n.warn("scriptman: invalid userscript",l,a),w=m.Breach());w.then(function(){b.replace&&!t&&(t=A.getUidsByName(a.name,a.namespace)[0]);if(t)f=A.getMetaByUid(t);else if(a.uuid)t=a.uuid;else if(b.replace)t=x.createUUID();else return n.warn("scriptman: neither UUID, @uuid nor replace option set"),m.Breach();if(""!==t.replace(/[a-f0-9]{8}-[a-f0-9]{4}-4[a-f0-9]{3}-[89aAbB][a-f0-9]{3}-[a-f0-9]{12}/,
""))return n.warn("scriptman: invalid UUID",t),m.Breach();if(!b.clean&&!b.defaultscript&&f&&f.system)return m.Breach()}).then(function(){if(b.clean&&b.name&&b.name!=a.name||-1!=a.name.search("\n"))return l.errors.push(c.getMessage("Invalid_UserScript_name__Sry_")),m.Breach()}).then(function(){if(a.options.compat_uW_gmonkey)return l.errors.push(c.getMessage("This_script_uses_uW_gm_api_")),m.Breach()}).then(function(){if(f){f.name!=a.name&&(l.flags.renamed=!0);if(f.lastModified&&void 0!==b.lastModified&&
f.lastModified!==b.lastModified){var d=c.getMessage("some_secs");try{var e=Math.max(1,Math.floor((g-f.lastModified)/1E3));isNaN(e)||(d=e)}catch(p){}l.warnings.push(c.getMessage("CONFLICT__This_script_was_modified_0t0_seconds_ago_",d));l.flags.forceAsk=!0}a.version==f.version&&(b.save?l.flags.modification=!0:l.flags.reset=!0);b.clean&&(l.flags.factory=!0)}else l.flags.first_install=!0;a.includes.length||a.matches.length||k||b.internal||l.warnings.push(c.getMessage("This_script_does_not_provide_any__include_information_"));
l.flags.sync=!!b.sync;l.flags.internal=b.internal;l.flags.ask=b.ask}).then(function(){a.uuid=t;a.system=b.defaultscript;a.evilness=v.getEvilness(a);a.position=v.determineLastPosition()+1;a.lastUpdated=b.force_meta&&b.force_meta.lastUpdated||g;l.flags.factory||l.flags.reset?f&&(a.lastUpdated=f.lastUpdated):(b.force_url&&(a.updateURL=null,a.downloadURL=b.force_url),f&&(a.options.override=f.options.override,a.options.comment=f.options.comment));["includes","excludes","matches","connects"].forEach(function(b){a.options.override["orig_"+
b]=a[b]});a.options.override.orig_noframes=a.options.noframes;a.options.override.orig_run_at=a.options.run_at||"document-idle";a.options.noframes=null;a.options.run_at=null}).then(function(){if(f&&(a.fileURL=f.fileURL,a.position=f.position,f.sync&&(a.sync=f.sync),!l.flags.factory&&!l.flags.reset)){a.enabled=f.enabled;a.options.noframes=f.options.noframes;a.options.run_at=f.options.run_at;a.options.awareOfChrome||(a.options.compat_forvarin=f.options.compat_forvarin);b.save&&!b.force_url&&(a.downloadURL=
f.downloadURL||a.downloadURL);var e=d.determineMetaURL(f),p=d.determineMetaURL(a),e=e?B.woHash(e):e,p=p?B.woHash(p):p;e==p||k||b.internal||l.warnings.push(c.getMessage("The_update_url_has_changed_from_0oldurl0_to__0newurl0",[e,p]))}}).then(function(){if(f&&!l.flags.factory&&a.version==f.version&&(b.defaultscript||b.noreinstall))return m.Breach()}).then(function(){f?(l.flags.factory||l.flags.reset?(l.flags.reset?(l.heading=c.getMessage("You_are_about_to_reinstall_a_UserScript_"),l.flags.reinstall=
!0):(l.heading=c.getMessage("You_are_about_to_install_a_UserScript_"),l.flags.install=!0),b.internal||l.warnings.splice(0,0,c.getMessage("All_script_settings_will_be_reset_"))):l.flags.modification?l.heading=c.getMessage("You_are_about_to_modify_a_UserScript_"):y.versionCmp(a.version,f.version)==y.versionCmp.eOLDER?(l.heading=c.getMessage("You_are_about_to_downgrade_a_UserScript"),l.flags.downgrade=!0,k||b.internal||l.warnings.splice(0,0,c.getMessage("The_downgraded_script_might_have_problems_to_read_its_stored_data_"))):
(l.heading=c.getMessage("You_are_about_to_update_a_UserScript_"),l.flags.update=!0),l.info.push({label:c.getMessage("Installed_Version_"),value:"v"+f.version})):(l.heading=c.getMessage("You_are_about_to_install_a_UserScript_"),k||b.internal||(l.info.splice(0,0,c.getMessage("Malicious_scripts_can_violate_your_privacy_")),Q.getWarningsFor(d.determineSourceURL(a)).forEach(function(a){l.warnings.splice(0,0,a)})),l.flags.install=!0);l.flags.install?l.action=c.getMessage("Install"):l.flags.reinstall?l.action=
c.getMessage("Reinstall"):l.flags.modification?l.action=c.getMessage("Modify"):l.flags.downgrade?l.action=c.getMessage("Downgrade"):l.flags.update&&(l.action=c.getMessage("Update"))}).then(function(){b.url&&(a.fileURL=b.url);b.sync&&(a.sync=b.sync);b.force_options&&x.copy(b.force_options,a.options,(new y.Script).options,!0);b.force_settings&&x.copy(b.force_settings,a,["enabled","position"]);a=v.mergeCludes(a)}).then(function(){var b=!1,d;for(d in a.options)if(-1!=d.search("compat_")&&!0===a.options[d]){b=
!0;break}b&&l.info.push({label:c.getMessage("Note"),value:c.getMessage("A_recheck_of_the_GreaseMonkey_FF_compatibility_options_may_be_required_in_order_to_run_this_script_")})}).then(function(){["requires","resources"].forEach(function(b){a[b]=x.map(a[b],function(b){b.unsafe_url=b.url;b.abs_url=a.fileURL?a.fileURL.split("/").slice(0,-1).join("/"):null;b.url=null;return b})})}).done(function(){e.resolve({script:a,messages:l,short_info:[{label:c.getMessage("Author"),prop:"author"},{label:c.getMessage("Description"),
prop:"description"},{label:c.getMessage("Source"),prop:"fileURL"}]})}).fail(function(){e.reject({messages:l})});return e.promise()},g=function(b){var a=m(),f=b.messages,c=b.script,e=!f.flags.internal,g=function(){var a=d.doModify(c.uuid,c,e)||{};f.flags.modification||N.dropAll(c.uuid);(f.flags.first_install||f.flags.factory)&&A.setStorageByUid(c.uuid,{ts:Date.now()});return a},k={lastModified:void 0,installed:!0,renamed:f.flags.renamed};f.warnings.length||f.flags.ask?ba.install(b).done(function(b){b.ok&&
g();k.installed=b.ok;k.aborted=b.aborted;a.resolve(k)}).fail(function(b){a.reject(b)}):(g(),a.resolve(k));return a.promise()},k=x.getDebouncer(1E3),d={determineSourceURL:function(b){return b?x.select([b.downloadURL,b.fileURL],function(a){if(!a||"file:"!==B.parse(a).protocol)return a})[0]:null},determineMetaURL:function(b){if(!b)return null;var a,d=v.determineOrigin(b);d&&d.meta_header?a=b.fileURL:!b.fileURL||d&&!d.meta_url||(a=b.fileURL.replace(".user.js",".meta.js"),b.fileURL==a&&(a=b.fileURL.replace(".tamper.js",
".meta.js")),b.fileURL==a&&(a=null));return x.select([b.updateURL,b.downloadURL,a],function(a){if(!a||"file:"!==B.parse(a).protocol)return a})[0]},mergeCludes:function(b){var a,d,c=b.options.override;["includes","excludes","matches"].forEach(function(a){b[a]=c["merge_"+a]&&c["orig_"+a]?c["orig_"+a].slice():[]});if(c.use_includes)for(a=0;a<c.use_includes.length;a++)d=b.excludes.indexOf(c.use_includes[a]),0<=d&&b.excludes.splice(d,1),b.includes.push(c.use_includes[a]);if(c.use_matches)for(a=0;a<c.use_matches.length;a++)d=
b.excludes.indexOf(c.use_matches[a]),0<=d&&b.excludes.splice(d,1),b.matches.push(c.use_matches[a]);if(c.use_excludes)for(a=0;a<c.use_excludes.length;a++)b.excludes.push(c.use_excludes[a]);return b},doSave:function(b){return w(b).then(g)},doRemove:function(b,a){A.removeByUid(b,a);A.setStorageByUid(b,null);N.dropAll(b);return m.Pledge()},doModify:function(b,a,d){void 0===d&&(d=!0);A.setByUid(b,a,d);return d?N.loadResources(b,a.resources).then(function(){return N.loadRequires(b,a.requires)}).then(function(){var d=
[].concat(a.resources).concat(a.requires).map(function(a){return B.sanitize(a.unsafe_url,a.abs_url)});return N.dropAllBut(b,d)}):m.Pledge()},exportToJson:function(b,a){var d=m(),c=v.determineScriptsToRun(null);b&&(c=x.select(c,function(a){return b[a.uuid]}));c=na(c,!0);a&&!a.storage||c.forEach(function(a){a.storage=A.getStorageByUid(a.uuid)});c={scripts:c};if(!a||a.global_settings)c.global_settings=r.getValue(q.CONSTANTS.STORAGE.CONFIG,{});d.resolve(c);return d.promise()},importFromJson:function(b){if(!b||
!b.scripts||!b.scripts.length)return m.Breach();for(var a={},d=[],c={},e=0,k;k=b.scripts[e];e++)try{var h=m();"new-user-script"!=k.uuid&&(k.storage&&(c[k.uuid]=k.storage),w({uuid:k.uuid,name:k.name,src:k.source,force_settings:{enabled:k.enabled,position:k.position},force_options:k.options,force_meta:{lastUpdated:k.lastModified},replace:!0,url:k.file_url||k.update_url,ask:!1}).done(function(b){a[x.createUUID()]=b;h.resolve()}).fail(function(a){n.warn("import: Error @ script",k.name,a);h.resolve()}),
d.push(h.promise()))}catch(ca){n.warn("import: Error while importing script",k.name,ca)}var t=function(){var a=m();m.when(d).always(function(){a.resolve()});return a.promise()}().then(function(){return ba.import(a,b.global_settings)}).then(function(b){var d=m(),f=[],e=[];if(b.ok)for(var p=0,k;k=b.import_ids[p];p++)(function(){var b=k;if(a[b]){a[b].messages.warnings=[];var d=g(a[b]).done(function(){var d;(d=a[b].script.uuid)&&c[d]&&(d=A.setStorageByUid(d,{data:c[d].data||{},ts:Date.now()}),e.push(d))});
f.push(d)}})();m.when(f).always(function(){v.reorderScripts();m.when(e).always(function(){d.resolve(b)})});return d.promise()}).then(function(a){return b.global_settings&&a.global_settings?(a=r.setValue(q.CONSTANTS.STORAGE.CONFIG,b.global_settings).then(function(){t.done(function(){window.setTimeout(T.reset,1)});return m.Pledge({global_settings:!0})}),r.setTemporary(!0),a):m.Pledge({})});return t},installFromUrl:function(b,a,f){var e=m(),g=B.parse(b),h={messages:{errors:[c.getMessage("Unable_to_load_script_from_url_0url0",
b)],warnings:[]}};a=a||{};f=f||{};var w=["url",b,JSON.stringify(a)].join("_");if(k.is(w))return n.debug("scriptman: de-bounced installFromUrl",b),m.Breach();k.add(w);if(!g.protocol.match(/(https?|file):/))return n.warn("scriptman: can't install from ",b),m.Breach(h);"file:"!=g.protocol||q.RUNTIME.ALLOWS_FILE_SCHEME_ACCESS||n.warn("scriptman: Access to local files is forbidden! Loading the following script for installation may fail:",b,"-> more info:","http://tampermonkey.net/faq.php#Q204");var t=
function(a,b){if(!a)if(b)a=h,"file:"!=g.protocol||q.RUNTIME.ALLOWS_FILE_SCHEME_ACCESS||a.messages.warnings.unshift(c.getMessage("Tampermonkey_has_no_file_access_permission_"));else{e.reject();return}a.heading=c.getMessage("You_are_about_to_install_a_UserScript_");f.silent_fail?e.reject(a):ba.installError(a).always(function(a){e.reject(a)})};Y.getScriptFromURL(b).done(function(f){var c={url:b,src:f,ask:!0,replace:!0};a&&x.each(a,function(b,d){c[d]=a[d]});d.doSave(c).done(function(a){e.resolve(a.installed)}).fail(t)}).fail(function(a){t(null,
a)});return e.promise()},determineLastPosition:function(){var b=0;A.getUidList().forEach(function(a){var d=A.getByUid(a);d.script&&d.cond?d.script.position&&d.script.position>b&&(b=d.script.position):n.warn("scriptman: inconsistent script entry",a)});var a=new y.Script;a.position>b&&(b=a.position);return b},convertToRegExp:function(b,a){var d,c;try{!a&&1<b.length&&"/"==b.substr(0,1)?d=new RegExp(".*"+b.replace(/^\//g,"").replace(/\/$/g,"")+".*","i"):a?(c=B.getRegExpFromMatch(b),d=new RegExp(c)):(c=
B.getRegExpFromInclude(b),d=new RegExp(c,"i"))}catch(e){return n.warn("scriptman: invalid regexp ",b),!1}return d},matchUrl:function(b,a){return""===b.replace(a,"")},regexify:function(b,a){var f={},c={inc:"rinc",match:"rinc",exc:"rexc"};Object.keys(c).forEach(function(e){var g=b[e]&&b[e].length?b[e].map(function(a){return d.convertToRegExp(a,"match"===e)}).filter(function(a){return!1!==a}):null;if(g||a)f[c[e]]=(f[c[e]]||[]).concat(g||[])});return f},validUrl:function(b,a,f){var c=!1;if(a.rinc){if(a.rinc.every(function(a){return d.matchUrl(b,
a)?(n.debug('scriptman: @include "'+a+'" matched'+(f?" ("+f+")":'"')),c=!0,!1):!0}),!c)return c}else c=!0;a.rexc&&a.rexc.every(function(a){return d.matchUrl(b,a)?(n.debug('scriptman: @exclude "'+a+'" matched'+(f?" ("+f+")":'"')),c=!1):!0});return c},getEvilness:function(b){var a=0;return b.fileURL&&(a=Q.getEvilnessOf(b.fileURL))||b.downloadURL&&(a=Q.getEvilnessOf(b.downloadURL))||b.updateURL&&(a=Q.getEvilnessOf(b.updateURL))?(n.debug("scriptman: found blacklisted script",b),a):0},blackCheckAll:function(){A.getUidList().forEach(function(b){var a=
A.getByUid(b);if(a.script&&a.cond){var f=v.getEvilness(a.script);if(f!==a.script.evilness){if(f||void 0!==a.script.evilness)n.debug("scriptman: write blacklist state of ",a.script.name,f),f&&K.tS(a.script.name,f,"b");a.script.evilness=f;d.doModify(b,a.script,!1)}}})},reorderScripts:function(b,a){var f=d.determineScriptsToRun();if(b)for(var c=0;c<f.length;c++){var g=f[c];g.uuid==b&&(g.position=Number(a)+(g.position<a?.5:-.5))}f=e(f);c=1;for(g=0;g<f.length;g++){var k=f[g];k.position=c++;d.doModify(k.uuid,
k,!1)}},getUniqueScriptsForTab:function(b){var a=[];C.get.empty(b.id)?n.debug("bg: WARN: Tabs.get.urls["+b.id+"] is empty!"):x.each(C.get.urls(b.id),function(b,d){if(W.isAllowed(d))for(var c=v.determineScriptsToRun(d),e=0;e<c.length&&(0===b.frameId||!0!==c[e].options.noframes&&(null!==c[e].options.noframes||!0!==c[e].options.override.orig_noframes));e++){for(var g=!1,k=0;k<a.length;k++)if(a[k].uuid==c[e].uuid){g=!0;break}g||a.push(c[e])}});return a},determineScriptsToRun:function(b){var a=[];n.debug("scriptman: determineScriptsToRun @"+
b);A.getUidList().forEach(function(c){if(b){var e=J.items.regexp.get(c);if(!e){if(!(e=r.getValue(q.CONSTANTS.PREFIX.COND+c,null)))return;e=d.regexify(e,!0);J.items.regexp.set(c,e)}if(!d.validUrl(b,e,c))return}e=A.getByUid(c);e.script&&e.cond?a.push(e.script):n.warn("scriptman: inconsistent script entry",c,e)});return e(a)},isContexter:function(b){return b.options&&("context-menu"===b.options.run_at||null===b.options.run_at&&"context-menu"===b.options.override.orig_run_at)},determineOrigin:function(b){return d.determineOriginOfUrl(b.fileURL||
b.downloadURL||b.updateURL)},determineOriginOfUrl:function(b){if(b){var a=b.match(/https?:\/\/userscripts\.org\/scripts\/(source|version)\/([0-9]{1,9})\.user\.js/)||b.match(/https?:\/\/userscripts-mirror\.org\/scripts\/(source|version)\/([0-9]{1,9})\.user\.js/);if(a&&3==a.length)return{id:a[2],token:"uso",meta_url:!0,url:"http://userscripts-mirror.org/scripts/show/"+a[2],issue_url:"http://contactbyweb.com/userscripts-mirror"};if((a=b.match(/https?:\/\/greasyfork\.org\/scripts\/([^/]+)\/code\/.*\.user\.js/))&&
2==a.length)return{id:a[1],token:"gf",meta_url:!0,url:"https://greasyfork.org/scripts/"+a[1],issue_url:"https://greasyfork.org/scripts/"+a[1]+"/feedback"};if((a=b.match(/https?:\/\/openuserjs\.org\/install\/([^/]+)+\/(.*)\.user\.js/))&&3==a.length)return a.shift(),{id:a.join("/"),token:"ouj",meta_header:!0,url:"https://openuserjs.org/scripts/"+a[0]+"/"+a[1],issue_url:"https://openuserjs.org/scripts/"+a[0]+"/"+a[1]+"/issues"};if((a=b.match(/https?:\/\/monkeyguts\.com\/(codepages\/)?([0-9]{1,9})\.user\.js/))&&
3==a.length)return{id:a[2],token:"mog",meta_url:!0,url:"https://monkeyguts.com/code.php?id="+a[2],issue_url:"https://monkeyguts.com/code.php?nav=rev&id="+a[2]};if((b=b.match(/https?:\/\/raw\.githubusercontent\.com\/([^/]+)\/([^/]+)\/.*\.user\.js/)||b.match(/https?:\/\/github\.com\/([^/]+)\/([^/]+)\/raw\/.*\.user\.js/)||b.match(/https?:\/\/github\.com\/([^/]+)\/([^/]+)\/releases\/download\/.*\.user\.js/))&&3==b.length)return b.shift(),{id:b.join("/"),token:"gh",url:"https://github.com/"+b.join("/"),
issue_url:"https://github.com/"+b.join("/")+"/issues"}}}};return d}(),A=function(){var c=[],m={init:function(){r.addDifferentOriginChangeListener(q.CONSTANTS.PREFIX.STORE,function(c,e){if(e&&e.hasOwnProperty("value")&&e.origin){var d=c.replace(q.CONSTANTS.PREFIX.STORE,""),b;for(b in e.value.data)e.value.data.hasOwnProperty(b)&&function(){var a=b,c=e.value.data[b];m.notifyStorageListeners({uuid:d},null,function(b){var d={data:{},ts:0};d.data[a]=c;d.ts=e.value.data.ts;var g={storage:d};void 0===d.data[a]&&
(g.removed=a);b(g)})}()}})},getUidList:function(){var c=new RegExp("^"+q.CONSTANTS.PREFIX.SCRIPT_UID),e=[];r.listValues().forEach(function(d){-1!=d.search(c)&&e.push(d.replace(c,""))});return e},getUidsByName:function(c,e){var d=[];m.getUidList().forEach(function(b){var a=m.getMetaByUid(b);!a||a.name!=c||e&&e!=a.namespace||d.push(b)});return d},getUidByName:function(c){return m.getUidsByName(c)[0]},getStorageByUid:function(c){c=r.getValue(q.CONSTANTS.PREFIX.STORE+c,{ts:0,data:{}});"undefined"===typeof c.ts&&
(c.ts=0);"undefined"===typeof c.data&&(c.data={});return c},setStorageByUid:function(c,e){return e?r.setValue(q.CONSTANTS.PREFIX.STORE+c,e):r.deleteValue(q.CONSTANTS.PREFIX.STORE+c)},getMetaByUid:function(c){return r.getValue(q.CONSTANTS.PREFIX.META+c,null)},getByUid:function(c){if(!c)return n.error("sb: no UUID set"),{};var e,d=r.getValue(q.CONSTANTS.PREFIX.META+c,null);if(d){var b=function(a){if(a)for(var b=0,d=null;d=a[b];b++)delete d.loaded,delete d.textContent,delete d.resURL,delete d.resText};
b(d.requires);b(d.resources);d.uuid=c;d.options.override.use_connects||(d.connects=d.connects||[],d.options.override.merge_connects=!0,d.options.override.use_connects=[]);d.grant=d.grant||[];d.textContent=r.getValue(q.CONSTANTS.PREFIX.SCRIPT+c,d.textContent);d.textContent&&(e=d)}return{script:e,cond:r.getValue(q.CONSTANTS.PREFIX.COND+c,null)}},setByUid:function(c,e,d){var b={};if(!c)return n.error("sb: no UUID set",e),b;if(null===e.textContent||void 0===e.textContent)throw Error("No script code set!");
var a=r.getValue(q.CONSTANTS.PREFIX.META+c),f=!a;r.setValue(q.CONSTANTS.PREFIX.SCRIPT_UID+c,e.name);r.setValue(q.CONSTANTS.PREFIX.COND+c,{inc:e.includes,match:e.matches,exc:e.excludes});r.setValue(q.CONSTANTS.PREFIX.SCRIPT+c,e.textContent);var l=x.copy(e,{});l.textContent=null;d&&(b.lastModified=Date.now(),l.lastModified=b.lastModified);r.setValue(q.CONSTANTS.PREFIX.META+c,l);d&&(ha.onScriptsChanged(),f?H.scriptAddedCb(e.name,e):H.scriptChangedCb(e.name,e,a),h.values&&K.tS(e.name,e.fileURL,f?"i":
"u"));J.items.rundata.removeAll();J.items.regexp.remove(c);return b},removeByUid:function(c,e){void 0===e&&(e=!0);var d=m.getByUid(c);r.deleteValue(q.CONSTANTS.PREFIX.SCRIPT_UID+c);r.deleteValue(q.CONSTANTS.PREFIX.COND+c);r.deleteValue(q.CONSTANTS.PREFIX.SCRIPT+c);r.deleteValue(q.CONSTANTS.PREFIX.META+c);r.deleteValue(q.CONSTANTS.PREFIX.STORE+c);e&&(ha.onScriptsChanged(),d.script&&d.cond&&(H.scriptRemovedCb(d.script.name,d.script),h.values&&K.tS(d.script.name,null,"r")));J.items.rundata.removeAll();
J.items.regexp.remove(c);return{}},addStorageListener:function(g,k,d,b,a){c.push({tabid:g,id:k,uuid:d,time:b,response:a})},removeStorageListeners:function(g,k){void 0===k&&(k=!0);var d=c;c=[];d.forEach(function(b){try{void 0!==g.tabid&&g.tabid!==b.tabid||void 0!==g.uuid&&g.uuid!==b.uuid||void 0!==g.id&&g.id!==b.id?c.push(b):k&&b.response({})}catch(a){n.debug("sb: listener clear for script",g,"failed! Page reload?!")}})},notifyStorageListeners:function(g,k,d){g=g||{};k=k||{};c.forEach(function(b){try{void 0!==
k.uuid&&b.uuid===k.uuid||void 0!==k.tabid&&b.tabid===k.tabid||void 0!==k.id&&b.id===k.id||void 0!==g.tabid&&g.tabid!==b.tabid||void 0!==g.uuid&&g.uuid!==b.uuid||void 0!==g.id&&g.id!==b.id||d&&d(b.response)}catch(a){n.warn("sb: listener notification for script",g,"failed! Page reload?!")}})}};return m}();scbr=A;var ta=function(){var e={ping:{allow:{insecure:!0},exec:function(d,b,a){a({pong:!0,instanceID:sa,config:{layout:h.values.layout}})}},newTab:{allow:{extpage:!0},exec:function(d,b,a){rea.tabs.create({url:d.url},
function(b){a({tabId:b.id})})}},getTab:{allow:{script:!0},exec:function(d,b,a){b.tab&&d.uuid?(M[b.tab.id]||(M[b.tab.id]={}),M[b.tab.id][d.uuid]||(M[b.tab.id][d.uuid]={}),a({data:M[b.tab.id][d.uuid]})):(n.warn("bg: unable to process request",b,d),a({data:null}))}},getTabs:{allow:{script:!0},exec:function(d,b,a){if(d.uuid){var c={};Object.keys(M).forEach(function(a){c[a]={};c[a]=M[a][d.uuid]});a({data:c})}else n.warn("bg: unable to process request",b,d),a({data:null})}},setTab:{allow:{script:!0},exec:function(d,
b,a){if(b.tab&&d.uuid){M[b.tab.id]||(M[b.tab.id]={});var c={};d.tab&&Object.keys(d.tab).forEach(function(a){c[a]=d.tab[a]});M[b.tab.id][d.uuid]=c}else n.warn("bg: unable to process request",b,d);a({})}},focusTab:{allow:{script:!0},exec:function(d,b,a){(d=b&&b.tab?b.tab.id:null)?rea.tabs.update(d,{active:!0},function(){a({error:rea.runtime.lastError})}):a({error:"internal error"})}},closeTab:{allow:{script:!0},exec:function(d,b,a){var c=b&&b.tab?b.tab.id:null;c?rea.tabs.query({windowType:"normal"},
function(b){1>=b.length?(n.warn("bg:","refused to close last tab!"),a({error:"refused to close last tab!"})):rea.tabs.remove(c,function(){a({})})}):a({error:"internal error"})}},copyToClipboard:{allow:{script:!0,extpage:!0},exec:function(d,b,a){b.tab?oa.copy(d.data):n.warn("bg: unable to process request",b,d);a({})}},setOption:{allow:{extpage:!0},exec:function(d,b,a){b="options"==b.extpage||"options"==d.origin;h.values[d.name]=d.value;b?U.create("options.settings").done(function(b){a({items:b,options:h.snapshot})}).fail(function(b){a({error:b,
options:h.snapshot})}):a({})}},reportAnIssue:{allow:{extpage:!0},exec:function(d,b,a){var c,e,g;d.uuid&&(c=A.getByUid(d.uuid))&&c.script&&c.cond&&(b=v.determineOrigin(c.script),"author"==d.to&&c.script.supportURL?(e={url:c.script.supportURL},g=b?[d.to,b.token,b.id].join(":"):[d.to,e.url].join(":")):b&&(e=b,g=[e.token,e.id].join(":")),e&&(K.tS(c.script.name,g,"m"),rea.tabs.create({url:e.issue_url||e.url,active:!0},function(){})));a({})}},begEvent:{allow:{extpage:!0},exec:function(d,b,a){if("dialog"==
d.action)Z.dialog.shown(d.extra);else if("clicked"==d.action){var c,e;d.extra&&(c=d.extra.amount,e=d.extra.currency);Z.clicked(d.type,c,e)}else if(Z.button[d.action])Z.button[d.action](d.extra);else n.warn("bg: Warning: unknown request ",d);a({})}},buttonPress:{allow:{extpage:!0},exec:function(d,b,a){var c=function(){a({})};if("reset_simple"==d.name)T.reset(c);else if("reset_factory"==d.name)T.factoryReset(c);else if("create_tesla_data"==d.name)H.createTeslaData().done(function(a){oa.copy({content:G.UTF8.encode(a.join("<br>")),
type:"html"});c()});else if("reset_chrome_sync"==d.name)H.reset().always(c);else if("install_tests"==d.name)(b=fa.framework.prepare(v.doSave,q.RUNTIME.BROWSER,q.RUNTIME.BROWSER_VERSION,c))&&n.error(b);else if("enabled"==d.name)h.values[d.name]=!h.values[d.name],a({});else if("installFromUrl"==d.name)v.installFromUrl(d.data).always(function(){a({})});else if("externals_delete"==d.name)N.cleanElement(d.scriptuid,d.safe_url),U.create("options.scripts").done(function(b){a({items:b,options:h.snapshot})}).fail(function(b){a({error:b,
options:h.snapshot})});else if("focus_tab"==d.name)e.focusTab.exec({},{tab:{id:d.tabid}},a);else if("run_script_updates"==d.name)if(d.scriptuid){var l;Y.check(!0,!1,d.scriptuid).done(function(a){l=a}).always(function(){a({scriptuid:d.scriptuid,updatable:l})})}else Y.check(!0,!0),a({});else n.warn("bg: Warning: unknown button "+d.name),a({})}},loadTree:{allow:{extpage:!0},exec:function(d,b,a){U.create(d.referrer,{complete:d.complete,uuid:d.uuid}).done(function(b){a({items:b,i18n:h.values.i18n,options:h.snapshot,
begging:Z.needed()})}).fail(function(b){a({error:b,options:h.snapshot})})}},modifyScriptOptions:{allow:{extpage:!0},exec:function(d,b,a){if(d.uuid){var c="options"==b.extpage||"options"==d.origin,l=void 0==d.reload||1==d.reload,g=A.getByUid(d.uuid);if(g.script&&g.cond){var k=!1,m=new y.Script;Object.keys(m.options).forEach(function(a){void 0!==d[a]&&(g.script.options[a]=d[a])});Object.keys(m.options.override).forEach(function(a){-1!=a.search("merge_")&&void 0!==d[a]&&(g.script.options.override[a]=
d[a],k=!0)});["includes","excludes","matches"].forEach(function(a){void 0!==d[a]&&(k=!0,g.script.options.override["use_"+a]=d[a])});["connects","blockers"].forEach(function(a){void 0!==d[a]&&(g.script.options.override["use_"+a]=d[a])});k&&(g.script=v.mergeCludes(g.script));d.temp_connects&&ea.setSessionConnects(g.script.uuid,d.temp_connects);void 0!==d.enabled&&(g.script.enabled=d.enabled);v.doModify(g.script.uuid,g.script,!1).done(function(){l?(void 0!==d.position&&v.reorderScripts(d.uuid,d.position),
c?e.loadTree.exec({referrer:"options.scripts"},b,a):rea.tabs.getSelected(null,function(b){U.create("actions").done(function(b){a({items:b,i18n:h.values.i18n,options:{enabled:h.values.enabled,layout:h.values.layout}})}).fail(function(){a({i18n:h.values.i18n,options:{enabled:h.values.enabled,layout:h.values.layout}})});d.uuid&&h.values.autoReload&&rea.tabs.sendMessage(b.id,{method:"reload",frameId:0},function(){})})):a({})}).fail(function(){a({})});return!0}}a({})}},modifyNativeScript:{allow:{extpage:!0},
exec:function(d,b,a){if(d.nid){var f=void 0==d.reload||1==d.reload;L.getUserscriptById(d.nid).then(function(a){if(a)if("installed"==d.actionid){if("false"==d.value)return L.uninstall(a)}else{if("enabled"==d.actionid)return L.setEnabled(a,d.value);if("imported"==d.actionid&&"true"==d.value){var e=L.getUserscriptSource(a);if(e)return v.doSave({src:e,ask:!0,replace:!0}).then(function(b){if(b.installed){if("disable"==h.values.native_import_post_action)return L.setEnabled(a,!1);if("uninstall"==h.values.native_import_post_action)return L.uninstall(a)}});
rea.tabs.sendMessage(b.tab.id,{method:"showMsg",msg:c.getMessage("Please_double_check_the_native_script_import_settings__")},function(){})}}else f=!1;return m.Pledge()}).always(function(){f?e.loadTree.exec({referrer:"options.scripts"},b,a):a({})});return!0}a({})}},saveScript:{allow:{extpage:!0},exec:function(d,b,a){var e=void 0===d.reload||!!d.reload,l=function(b){e?U.create("options.scripts").done(function(d){b.items=d;b.options=h.snapshot;a(b)}).fail(function(b){a({error:b,options:h.snapshot})}):
a({})};if(d.clean){n.debug("bg: clean userscript "+d.uuid);b=A.getByUid(d.uuid);var g=function(b){U.create("options.scripts").done(function(c){a({cleaned:b.installed,items:c,options:h.snapshot});b.installed&&A.notifyStorageListeners({uuid:d.uuid},null,function(a){a({storage:A.getStorageByUid(d.uuid)})})}).fail(function(b){a({error:b,options:h.snapshot})})};b.script&&b.cond?v.doSave({name:d.name,uuid:d.uuid,src:b.script.textContent,clean:!0,ask:!1,internal:!0,save:!0}).always(function(a){g(a||{installed:!1})}):
(n.error(c.getMessage("fatal_error")+" ("+d.uuid+")!!!"),g({installed:!1}))}else if(d.code){var k=a;e&&(k=function(a){v.reorderScripts();l(a)});d.new_script&&(d.uuid=x.createUUID());v.doSave({name:d.name,uuid:d.uuid,force_url:d.force_url,src:d.code,ask:!h.values.editor_easySave,lastModified:d.lastModified,save:!0}).always(function(a){k(a||{installed:!1})})}else d.auto_save||(v.doRemove(d.uuid),v.reorderScripts()),l({})}},exportToJson:{allow:{extpage:!0},exec:function(d,b,a){v.exportToJson(d.ids,d.options).done(function(b){a({json:b})}).fail(function(){a({})})}},
importFromJson:{allow:{extpage:!0},exec:function(d,b,a){var e=void 0===d.reload||!!d.reload;v.importFromJson(d.json).fail(function(b){a({error:b||c.getMessage("An_error_occured_during_import_")})}).done(function(b){var d={reload:b.global_settings};e&&!d.reload?U.create("options.scripts").done(function(b){d.items=b;d.options=h.snapshot;a(d)}).fail(function(b){a({error:b,options:h.snapshot})}):a(d)})}},askCom:{allow:{extpage:!0},exec:function(d,b,a){ba.onMessage(d.data).always(function(b){b.i18n=h.values.i18n;
b.options={statistics_enabled:h.values.statistics_enabled};b.ext={version:rea.extension.manifest.version};a(b)})}},installScript:{allow:{insecure:!0},exec:function(d,b,a){if(b.tab){var e={};v.installFromUrl(d.url,{},{silent_fail:!0}).done(function(a){e={data:null,found:!0,installed:a}}).fail(function(a){e.err=a&&a.messages&&a.messages.errors?a.messages.errors[0]:c.getMessage("Unable_to_parse_this_")}).always(function(){a(e)})}else n.warn("bg: Error: unable to install script due to empty tabID!")}},
execMenuCmd:{allow:{extpage:!0},exec:function(d,b,a){(d=aa.getById(d.id))?d.response({run:!0,menuId:d.id}):n.warn("bg: Error: unable to find MC id "+d.id);a({})}},unLoad:{allow:{script:!0},exec:function(d,b){d.topframe||d.id&&b.frameId&&C.events.unload(b.tab.id,b.frameId,d.id)}},prepare:{allow:{script:!0},exec:function(d,b,a){if(b.tab){var c=void 0!==b.frameId?b.frameId:d.topframe?0:null,e=B.woHash(d.url);C.events.run(b.tab.id,c,d.id,e,function(c){c=c?da.answer(c,d.url):null;a(c);R.setIcon(b.tab.id);
R.setBadge(b.tab.id)});return!0}a({});return!1}},notification:{allow:{script:!0,extpage:!0},exec:function(d,b,a){var c=d.image?d.image:rea.extension.getURL("images/icon128.png");(function(){var a=m();d.highlight&&b.tab?P.highlight(b.tab.id,a.resolve):a.resolve();return a.promise()})().then(function(){var a=m();d.text?P.show(d.title,d.text,c,d.timeout,a.resolve):a.resolve();return a.promise()}).always(function(b){a({clicked:b&&b.clicked})})}},determineScriptsToRun:{allow:{extpage:!0},exec:function(d,
b,a){a({scripts:v.determineScriptsToRun(d.url).map(function(a){return a.uuid})})}},syntaxCheck:{allow:{script:!0,extpage:!0},exec:function(d,b,a){(function(){var a=m();Registry.require("hinter",function(){a.resolve(Registry.get("hinter"))});return a.promise()})().then(function(a){return a.hint(d.code,{maxerr:999},{})}).always(function(b){a({errors:b})})}},externalMessage:{allow:{insecure:!0},exec:function(d,b,a){d=d.request;var c;if("off"!=h.values.external_connect&&(c=b.url)&&W.isAllowed(c)){for(var e,
g,m,w=Object.keys(k.externally_connectable),t=0;t<w.length;t++)if(e=w[t],b=k.externally_connectable[e],(g=v.regexify({match:[e]}))&&v.validUrl(c,g)&&(-1!=b.indexOf("*")||-1!=b.indexOf(d.method))){m=!0;break}if(m)if("getVersion"==d.method)a({version:rea.extension.manifest.version,id:rea.runtime.short_id});else if("all"!=h.values.external_connect)n.warn("mh: calling external method "+d.method+" is not permitted to "+c+" by the user");else if("isInstalled"==d.method){var q,r,x,y;c=!1;g=d.script.name;
(r=A.getUidsByName(g,d.script.namespace)[0])&&(q=A.getByUid(r))&&q.script&&(c=!0,y=q.script.enabled,x=q.script.version);a({name:g,installed:c,enabled:y,version:x})}else n.warn("mh: unknown external method "+d.method);else n.warn("mh: calling external method "+d.method+" is not permitted to "+c)}}}},w=function(d,b,a){if(!D.late)return D.registerLateCallback(function(){w(d,b,a)}),!0;var c=e[d.method];if(c)if(c.allow&&c.exec){var g=rea.runtime.id,g=!q.REQUESTS.HAS_SENDER_ID&&b.tab||b.id===g,k=null,h=
q.REQUESTS.INTERNAL_PAGE_PROTOCOL+"//",m=q.REQUESTS.GET_INTERNAL_PAGE_REGEXP(),t=b.url?b.url:b.tab?b.tab.url:null;if(h=g&&(t?0==t.search(h):!0))t?(m=t.match(m))&&2==m.length&&(k=m[1]):k="*",b.extpage=k;m="options"==k;if("background"==k||c.allow.insecure||c.allow.extpage&&h||c.allow.options&&m||c.allow.script&&g&&!h){if(c=c.exec(d,b,a),void 0!==c)return c}else return!1===d.topframe&&(h||m)||n.warn("mh: this context doesn't have the permission to call \""+d.method+'"'),!1}else return n.warn("mh: invalid implementation of "+
d.method),!1;else return n.warn("mh: unknown method "+d.method),!1;return!0},g=function(){var d=function(b,a){var d=null,c=b.sender,e=this,g=function(a){try{b.postMessage(a)}catch(d){n.debug("bg: Error sending port ("+b.name+") message",a)}};if("xhr"==a.method){var k=!1,h=function(){b.disconnect()};a.details.convertBinary=!0;a.details.partialSize=a.details.partialSize||q.XMLHTTPREQUEST.PARTIAL_SIZE;var w={};Object.keys(a.callbacks).forEach(function(b){var d="ondone"===b;if(a.callbacks[b]||d||"onload"===
b)w[b]=function(a){a={data:a.response,exception:a.exception};a[b]=!0;g(a);d&&h()}});w.ondone||(w.ondone=h);var r=function(a){var b=m(),d=[];rea.cookies.getAll({url:a},function(a){d=d.concat(a);b.resolve(d)});return b.promise()},x;a.details.url=B.sanitize(a.details.url,a.url||c.url||null,["http:","https:"])||a.details.url;q.RUNTIME.WEBREQUEST_XHR_SUPPORT&&(a.details.headers=a.details.headers||{},a.details.headers.internal=a.uuid);(function(){return a.details.cookie&&a.details.url?r(a.details.url).then(function(b){b=
b.map(function(a){return a.name+"="+encodeURIComponent(a.value)}).concat([a.details.cookie]).join(";");delete a.details.cookie;a.details.headers=a.details.headers||{};a.details.headers.cookie=b}):m.Pledge()})().then(function(){k||(x=ea.exec(a.details,a.uuid,c||{},w))});d=function(){k=!0;x&&x.abort()}}else if("download"==a.method)I.start(a.details,{onload:function(a){g({load:!0,data:a})},onprogress:function(a){g({progress:!0,data:a})},onerror:function(a){g({error:!0,data:a})},ontimeout:function(a){g({timeout:!0,
data:a})},ondone:function(){b.disconnect()}});else if("addStorageListener"==a.method)c.tab?(A.addStorageListener(c.tab.id,a.id,a.uuid,Date.now(),g),d=function(){A.removeStorageListeners({uuid:a.uuid,id:a.id},!1)}):g({error:!0});else if("saveStorageKey"==a.method){if(c.tab){if(a.uuid){var v=A.getStorageByUid(a.uuid);v.data[a.key]=a.value;v.ts=a.ts;A.setStorageByUid(a.uuid,v);A.notifyStorageListeners({uuid:a.uuid},{id:a.id},function(b){var d={data:{},ts:0};d.data[a.key]=a.value;d.ts=a.ts;var c={storage:d};
void 0===d.data[a.key]&&(c.removed=a.key);b(c)})}}else n.warn("storage: unable to save storage due to empty tabID!");g({})}else if("openInTab"==a.method){var v=["active"],y={url:a.details.url};if(a.details.options){for(var D=0;D<v.length;D++)void 0!==a.details.options[v[D]]&&(y[v[D]]=a.details.options[v[D]]);a.details.options.insert&&(y.index=c.tab.index+1)}d=function(){e.disconnected=!0;e.tabId&&delete V[e.tabId]};rea.tabs.create(y,function(a){e.tabId=a.id;V[a.id]={onClose:function(){g({close:!0})}};
g({success:!0,tabId:a.id})})}else if("nameTab"==a.method){if(e.tabId){var H=3,G=function(){C.listeners.once.whenReady(e.tabId,function(){rea.tabs.sendMessage(e.tabId,{method:"setForeignAttr",attr:"name",value:a.name},function(b){b?g({name:a.name}):0<H--?G():n.warn("foreignAttr: error setting attr")})})};G()}}else if("closeTab"==a.method)e.tabId&&V[e.tabId]&&rea.tabs.remove(e.tabId),g({}),window.setTimeout(function(){try{e.disconnected||b.disconnect()}catch(a){}e.disconnected=!0},1E3);else if("registerMenuCommand"==
a.method)c.tab?(aa.add(c.tab.id,a.name,a.accessKey,a.menuId,g),xa(),d=function(){aa.clearById(a.menuId);xa()}):(n.warn("Unable to register menu cmd due to empty tabID!"),b.disconnect());else if("tabWatch"==a.method)if(c.tab&&c.tab.url&&(v=q.REQUESTS.GET_INTERNAL_PAGE_REGEXP())&&(y=c.tab.url.match(v))&&2==y.length&&(D=y[1])&&"options"==D){var E=null,J=function(a,c){null!==E&&c.id===E&&("updated"==a.reason?g({tab:c}):"removed"==a.reason&&(d(),b.disconnect()))};rea.tabs.create({url:a.url,index:(c.tab.index||
0)+1},function(a){E=a.id});pa.addListener(J);d=function(){null!==E&&(rea.tabs.remove(E,function(){}),E=null);pa.removeListener(J)}}else n.warn("Incomplete sender!"),b.disconnect();d&&b.onDisconnect.addListener(d)};return function(b){if(D.late){var a={};b.onMessage.addListener(function(c){d.apply(a,[b,c])})}else D.registerLateCallback(function(){g(b)})}}(),k={init:function(){k.externally_connectable_reg=v.regexify({match:Object.keys(k.externally_connectable)});rea.extension.onMessage.addListener(w);
rea.extension.onConnect.addListener(g);rea.extension.onConnectExternal.addListener(function(d){d.disconnect()})},externally_connectable:{"*://tampermonkey.net/*":["getVersion"],"https://greasyfork.org/*":["*"],"https://userstyles.org/*":["*"]}};return k}(),ya=function(){var e=[{name:c.getMessage("Default"),value:"default"},{}].filter(function(c){return c.name}),h=!1,g={default:c.getMessage("Default"),solarized:"Solarized",monokai:"Monokai",mdnlike:"MDN-like",eclipse:"Eclipse",railscasts:"RailsCasts"};
return{getLayouts:function(){if(!h){var c=ra.getLayouts().map(function(d){return{name:d.charAt(0).toUpperCase()+d.slice(1),value:d}});e=e.concat(c);h=!0}return e},getEditorThemes:function(){return ra.editorThemes.map(function(c){return{name:g[c]||c,value:c}})}}}(),aa=function(){var c=[];return{add:function(h,g,k,d,b){c.push({tabId:h,name:g,accessKey:k,id:d,response:b})},list:function(){return c},listByTabId:function(h){var g={};return c.filter(function(c){return c.tabId==h&&!g[c.name]&&(g[c.name]=
!0)})},clearByTabId:function(h){c=c.filter(function(c){return c.tabId!=h})},getByTabId:function(h){return c.filter(function(c){return c.tabId==h})[0]},clearById:function(h){c=c.filter(function(c){return c.id!=h})},getById:function(h){return c.filter(function(c){return c.id==h})[0]}}}(),Ea=function(){return{create:function(){var e,m,g,k,d,b,a,f,l,p,n,u,t,r;p=null;e={name:c.getMessage("General"),sub_menu_item:!0,items:[]};e.items.push({name:c.getMessage("Config_Mode"),id:"configMode",level:0,option:!0,
select:[{name:c.getMessage("Novice"),value:0},{name:c.getMessage("Beginner"),value:50},{name:c.getMessage("Advanced"),value:100}],value:h.values.configMode,desc:c.getMessage("Changes_the_number_of_visible_config_options")});e.items.push({name:c.getMessage("Language"),id:"i18n",level:0,option:!0,reload:!0,warning:c.getMessage("A_reload_is_required"),select:[{name:"Browser Default",value:null}].concat(c.supported),value:h.values.i18n,validation:{image:"info",opacity:.9,msg:c.getMessage("Your_language_is_not_supported__Click_here_to_get_intructions_how_to_translate_TM_"),
url:"http://tampermonkey.net/faq.php#Q500"}});e.items.push({name:c.getMessage("Auto_reload_on_script_enabled"),level:20,id:"autoReload",option:!0,checkbox:!0,enabled:h.values.autoReload,desc:c.getMessage("Auto_reload_on_script_enabled_desc")});e.items.push({name:c.getMessage("Anonymous_statistics"),level:0,id:"statistics_enabled",option:!0,checkbox:!0,enabled:h.values.statistics_enabled,validation:{image:"info",opacity:.9,msg:c.getMessage("Allow_Tampermonkey_to_collect_anonymous_statistics_via_Google_Analytics"),
url:"http://tampermonkey.net/privacy.php#extension"}});e.items.push({name:c.getMessage("Debug_scripts"),level:100,id:"debug",option:!0,checkbox:!0,enabled:h.values.debug,desc:""});e.items.push({name:c.getMessage("Show_fixed_source"),level:100,id:"showFixedSrc",option:!0,checkbox:!0,enabled:h.values.showFixedSrc,desc:""});e.items.push({name:c.getMessage("LogLevel"),id:"logLevel",level:0,option:!0,select:[{name:c.getMessage("Debug"),value:60},{name:c.getMessage("Warning"),value:30},{name:c.getMessage("Error"),
value:0}],value:h.values.logLevel,desc:""});q.OPTIONS.NATIVE_SCRIPT_IMPORT&&(m={name:c.getMessage("Native_Script_Import"),sub_menu_item:!0,need_save:!0,items:[]},p={},h.values.native_import&&(p=!0===q.RUNTIME.ALLOWS_FILE_SCHEME_ACCESS?{image:"button_ok",msg:c.getMessage("TM_has_access_to_file_URIs")}:{image:"critical",msg:c.getMessage("Tampermonkey_needs_access_to_file_URIs__Visit_the_FAQ_"),url:"http://tampermonkey.net/faq.php#Q204"}),m.items.push({name:c.getMessage("Enable_Native_Script_Import"),
id:"native_import",level:0,option:!0,checkbox:!0,enabled:h.values.native_import,validation:p}),m.items.push({name:c.getMessage("Post_Import_Action"),id:"native_import_post_action",level:0,option:!0,select:[{name:c.getMessage("None"),value:"none"},{name:c.getMessage("Disable_Extension"),value:"disable"},{name:c.getMessage("Uninstall_Extension"),value:"uninstall"}],value:h.values.native_import_post_action,desc:c.getMessage("What_action_should_be_done_after_a_native_userscript_was_imported_sucessfully_")}),
p={},h.values.native_import&&(p=L.isPathValid()?{image:"button_ok",msg:c.getMessage("Everything_is_setup_correctly_")}:{image:"critical",msg:c.getMessage("Tampermonkey_needs_to_know_the_absolute_path_to_your_browser_profile_folder_Visit_the_FAQ_"),url:"http://tampermonkey.net/faq.php#Q205"}),m.items.push({name:c.getMessage("Browser_Profile_Path"),id:"native_import_path",level:0,option:!0,text:!0,width:2,value:h.values.native_import_path,validation:p}));q.OPTIONS.HAS_TESLA&&(u={name:c.getMessage("TESLA"),
sub_menu_item:!0,level:50,need_save:!0,items:[]},u.items.push({name:c.getMessage("Enable_TESLA"),id:"sync_enabled",level:50,option:!0,checkbox:!0,enabled:h.values.sync_enabled,desc:c.getMessage("Tampermonkey_External_Script_List_Access")}),g=[{name:"pastebin.com",value:E.types.ePASTEBIN,enable:{sync_id:!0,sync_version:!1,create_tesla_data:!0}},{name:"Chrome Sync",value:E.types.eCHROMESYNC,enable:{sync_id:!1,sync_version:!0,create_tesla_data:!1}}],q.SYNC.GOOGLE_DRIVE.SUPPORTED&&g.push({name:"Google Drive (Beta)",
value:E.types.eGOOGLEDRIVE,enable:{sync_id:!1,sync_version:!1,create_tesla_data:!1}}),u.items.push({name:c.getMessage("Sync_Type"),id:"sync_type",enabler:!0,level:50,option:!0,select:g,value:h.values.sync_type}),u.items.push({name:c.getMessage("Sync_Id"),id:"sync_id",enabledBy:"sync_type",level:50,text:!0,value:h.values.sync_id,option:!0}),u.items.push({name:c.getMessage("Sync_Version"),id:"sync_version",enabledBy:"sync_type",level:50,option:!0,select:[{name:"v1 - Legacy",value:1},{name:"v2 - Beta",
value:2,warning:c.getMessage("This_sync_version_may_multiply_each_script_that_is_present_at_more_than_one_Tampermonkey_instance__Do_you_really_want_to_continue_")}],value:h.values.sync_version,desc:c.getMessage("Different_sync_versions_are_not_compatible_to_each_other_")}),u.items.push({name:c.getMessage("Create_Exportable_Data"),id:"create_tesla_data",enabledBy:"sync_type",button:!0,ignore:!0,level:60,warning:c.getMessage("Copy_exportable_data_to_clipboard_Ok_")}));b={name:c.getMessage("Appearance"),
sub_menu_item:!0,items:[]};b.items.push({name:c.getMessage("Layout"),id:"layout",level:0,option:!0,select:ya.getLayouts(),value:h.values.layout,desc:""});p={};"off"==h.values.notification_showUpdate&&(p={image:"critical",msg:c.getMessage("Are_you_sure_that_you_don_t_want_to_be_notified_of_updates_")});b.items.push({name:c.getMessage("Update_Notification"),id:"notification_showUpdate",level:50,option:!0,select:[{name:c.getMessage("Disabled"),value:"off"},{name:c.getMessage("Show_notification"),value:"notification"},
{name:c.getMessage("Open_changelog"),value:"changelog"}],value:h.values.notification_showUpdate,validation:p});a={name:c.getMessage("Action_Menu"),sub_menu_item:!0,items:[],level:50};a.items.push({name:c.getMessage("Hide_disabled_scripts"),id:"action_menu_scripts_hide_disabled",level:100,option:!0,checkbox:!0,enabled:h.values.action_menu_scripts_hide_disabled,desc:""});a.items.push({name:c.getMessage("Columns"),id:"action_menu_columns",level:50,option:!0,select:[{name:c.getMessage("1"),value:"1"},
{name:c.getMessage("2"),value:"2"},{name:c.getMessage("3"),value:"3"}].filter(function(a){return a.value<=q.ACTIONMENU.COLUMNS}),value:h.values.action_menu_columns});a.items.push({name:c.getMessage("Script_order"),id:"action_menu_scripts_sort",level:50,option:!0,select:[{name:c.getMessage("Position_"),value:"position"},{name:c.getMessage("Name"),value:"name"},{name:c.getMessage("Enabled"),value:"enabled"}],value:h.values.action_menu_scripts_sort});a.items.push({name:c.getMessage("Icon_badge_info"),
id:"appearance_badges",level:50,option:!0,select:[{name:c.getMessage("Disabled"),value:"off"},{name:c.getMessage("Running_scripts"),value:"running"},{name:c.getMessage("Unique_running_scripts"),value:"running_unique"},{name:c.getMessage("Disabled_scripts"),value:"disabled"}],value:h.values.appearance_badges});(q.RUNTIME.CHROME||q.RUNTIME.FIREFOX)&&a.items.push({name:c.getMessage("Icon_badge_color"),id:"appearance_badge_color",level:100,color:!0,value:h.values.appearance_badge_color});g={name:c.getMessage("Editor"),
sub_menu_item:!0,level:20,need_save:!0,items:[],warning:c.getMessage("A_reload_is_required"),reload:!0};g.items.push({name:c.getMessage("Enable_Editor"),id:"editor_enabled",level:100,option:!0,checkbox:!0,enabled:h.values.editor_enabled,desc:""});g.items.push({name:c.getMessage("Theme"),id:"editor_theme",level:50,option:!0,select:ya.getEditorThemes(),value:h.values.editor_theme});g.items.push({name:c.getMessage("Font_Size"),id:"editor_fontSize",level:50,option:!0,select:[{name:"50%",value:50},{name:"70%",
value:70},{name:"80%",value:80},{name:"90%",value:90},{name:"100%",value:100},{name:"110%",value:110},{name:"120%",value:120},{name:"150%",value:150}],value:h.values.editor_fontSize});g.items.push({name:c.getMessage("Key_Mapping"),id:"editor_keyMap",level:50,option:!0,select:[{name:c.getMessage("Windows"),value:"windows"},{name:c.getMessage("Sublime"),value:"sublime"},{name:c.getMessage("Emacs"),value:"emacs"},{name:c.getMessage("Vim"),value:"vim"}],value:h.values.editor_keyMap});g.items.push({name:c.getMessage("Indentation_Width"),
id:"editor_indentUnit",level:50,option:!0,select:[{name:c.getMessage("1"),value:1},{name:c.getMessage("2"),value:2},{name:c.getMessage("3"),value:3},{name:c.getMessage("4"),value:4},{name:c.getMessage("5"),value:5},{name:c.getMessage("6"),value:6},{name:c.getMessage("7"),value:7},{name:c.getMessage("8"),value:8},{name:c.getMessage("9"),value:9},{name:c.getMessage("10"),value:10},{name:c.getMessage("11"),value:11}],value:h.values.editor_indentUnit,desc:""});g.items.push({name:c.getMessage("Indent_with"),
id:"editor_indentWithTabs",level:50,option:!0,select:[{name:c.getMessage("Tabs"),value:"tabs"},{name:c.getMessage("Spaces"),value:"spaces"}],value:h.values.editor_indentWithTabs,desc:""});g.items.push({name:c.getMessage("TabMode"),id:"editor_tabMode",level:50,option:!0,select:[{name:c.getMessage("Classic"),value:"classic"},{name:c.getMessage("Smart"),value:"smart"},{name:c.getMessage("Indent"),value:"indent"}],value:h.values.editor_tabMode,desc:""});g.items.push({name:c.getMessage("Line_break"),id:"editor_lineWrapping",
level:50,option:!0,checkbox:!0,enabled:h.values.editor_lineWrapping,desc:""});g.items.push({name:c.getMessage("Reindent_on_typing"),id:"editor_electricChars",level:50,option:!0,checkbox:!0,enabled:h.values.editor_electricChars,desc:""});g.items.push({name:c.getMessage("Enable_autoSave"),id:"editor_autoSave",level:20,option:!0,checkbox:!0,enabled:h.values.editor_autoSave,desc:""});g.items.push({name:c.getMessage("Enable_easySave"),id:"editor_easySave",level:20,option:!0,checkbox:!0,enabled:h.values.editor_easySave,
desc:""});g.items.push({name:c.getMessage("Highlight_trailing_whitespace"),id:"editor_highlightTrailingWhitespace",level:50,option:!0,checkbox:!0,enabled:h.values.editor_highlightTrailingWhitespace,desc:""});g.items.push({name:c.getMessage("Auto_syntax_check_on_typing"),id:"editor_autoLint",level:50,option:!0,checkbox:!0,enabled:h.values.editor_autoLint,desc:c.getMessage("Enable_this_option_to_automatically_check_the_code_on_typing_")});g.items.push({name:c.getMessage("Auto_syntax_check_max_length"),
id:"editor_autoLintMaxLen",level:50,option:!0,text:!0,value:h.values.editor_autoLintMaxLen,desc:c.getMessage("Check_only_scripts_up_to_this_size_automatically_")});d={name:c.getMessage("Script_Update"),sub_menu_item:!0,level:0,items:[]};d.items.push({name:c.getMessage("Check_disabled_scripts"),id:"scriptUpdateCheckDisabled",level:0,option:!0,checkbox:!0,enabled:h.values.scriptUpdateCheckDisabled,desc:""});d.items.push({name:c.getMessage("Dont_ask_me_for_simple_script_updates"),id:"notification_silentScriptUpdate",
level:80,option:!0,checkbox:!0,enabled:h.values.notification_silentScriptUpdate,desc:""});d.items.push({name:c.getMessage("Check_interval"),id:"scriptUpdateCheckPeriod",level:0,option:!0,select:[{name:c.getMessage("Never"),value:0},{name:c.getMessage("Every_6_Hours"),value:216E5},{name:c.getMessage("Every_12_Hour"),value:432E5},{name:c.getMessage("Every_Day"),value:864E5},{name:c.getMessage("Every_Week"),value:6048E5}],value:h.values.scriptUpdateCheckPeriod,desc:""});d.items.push({name:c.getMessage("Hide_notification_after"),
id:"scriptUpdateHideNotificationAfter",level:50,option:!0,select:[{name:c.getMessage("Never"),value:0},{name:c.getMessage("15_Seconds"),value:15E3},{name:c.getMessage("30_Seconds"),value:3E4},{name:c.getMessage("1_Minute"),value:6E4},{name:c.getMessage("5_Minutes"),value:3E5},{name:c.getMessage("1_Hour"),value:36E5}],value:h.values.scriptUpdateHideNotificationAfter,desc:""});k={name:c.getMessage("Externals"),sub_menu_item:!0,level:0,items:[]};k.items.push({name:c.getMessage("Update_interval"),id:"external_update_interval",
level:0,option:!0,select:[{name:c.getMessage("Always"),value:1},{name:c.getMessage("Every_Day"),value:864E5},{name:c.getMessage("Every_Week"),value:6048E5},{name:c.getMessage("Every_Month"),value:2592E6},{name:c.getMessage("Never"),value:0}],value:h.values.external_update_interval,desc:""});f={name:c.getMessage("Security"),sub_menu_item:!0,level:50,items:[]};q.OPTIONS.HAS_CSP&&(f.items.push({name:c.getMessage("Add_TM_to_CSP"),id:"webrequest_fixCSP",level:80,option:!0,select:[{name:c.getMessage("Yes"),
value:"yes"},{name:c.getMessage("No"),value:"no"}],value:h.values.webrequest_fixCSP,desc:c.getMessage("Tampermonkey_might_not_be_able_to_provide_access_to_the_unsafe_context_when_this_is_disabled")}),f.items.push({name:c.getMessage("Allow_headers_to_be_modified_by_scripts"),id:"webrequest_modHeaders",level:80,option:!0,reload:!0,select:[{name:c.getMessage("Yes"),value:"yes"},{name:c.getMessage("Auto"),value:"auto"},{name:c.getMessage("No"),value:"no"}],value:h.values.webrequest_modHeaders,warning:c.getMessage("Tampermonkey_needs_to_be_restarted_to_make_this_change_apply_Do_you_want_to_continue_"),
desc:""}));f.items.push({name:c.getMessage("Allow_communication_with_cooperate_pages"),id:"external_connect",level:80,option:!0,reload:!0,select:[{name:c.getMessage("Tampermonkey_and_script_version"),value:"all"},{name:c.getMessage("Tampermonkey_version"),value:"version"},{name:c.getMessage("Disabled"),value:"off"}],value:h.values.external_connect,desc:c.getMessage("This_option_allows_the_Tampermonkey_homepage_and_some_script_hosting_pages_to_determine_the_Tampermonkey_version_and_whether_a_script_is_installed_")});
f.items.push({name:c.getMessage("Subresource_Integrity"),id:"require_sri_mode",level:80,option:!0,select:[{name:c.getMessage("Disabled"),value:"ignore"},{name:c.getMessage("Validate_if_supported"),value:"supported"},{name:c.getMessage("Validate_if_given"),value:"given"},{name:c.getMessage("Enforce"),value:"enforce"}],value:h.values.require_sri_mode,desc:c.getMessage("Script_authors_can_secure_external_resources_by_adding_a_SRI_hash_to_the_URL_")});f.items.push({name:c.getMessage("connect_mode"),id:"connect_mode",
level:50,option:!0,select:(80<=h.values.configMode||-1!=["off","casual"].indexOf(h.values.connect_mode)?[{name:c.getMessage("Disabled"),value:"off"},{name:c.getMessage("Casual"),value:"casual"}]:[]).concat([{name:c.getMessage("Ask_if_unknown"),value:"ask"},{name:c.getMessage("Strict"),value:"strict"},{name:c.getMessage("Always_ask"),value:"paranoid"}]),value:h.values.connect_mode,desc:""});q.RUNTIME.INCOGNITO_MODE&&!rea.extension.inIncognitoContext&&(p="temporary"==h.values.incognito_mode?{}:{image:"critical",
msg:"Permanent mode is still a BETA feature!"},f.items.push({name:c.getMessage("Store_data_in_incognito_mode"),id:"incognito_mode",level:50,option:!0,select:[{name:c.getMessage("Temporary"),value:"temporary"},{name:c.getMessage("Permanent"),value:"permanent"}],value:h.values.incognito_mode,validation:p}));f.items.push({name:c.getMessage("Page_Filter_Mode"),id:"page_filter_mode",level:50,option:!0,select:[{name:c.getMessage("Disabled"),value:"off"},{name:c.getMessage("Blacklist"),value:"black"},{name:c.getMessage("Whitelist"),
value:"white"},{name:c.getMessage("Both"),value:"black+white"}],value:h.values.page_filter_mode,desc:""});f.items.push({name:c.getMessage("Whitelisted_Pages"),id:"page_whitelist",level:50,option:!0,input:!0,array:!0,value:h.values.page_whitelist,desc:""});f.items.push({name:c.getMessage("Blacklisted_Pages"),id:"forbiddenPages",level:50,option:!0,input:!0,array:!0,value:h.values.forbiddenPages,desc:""});l={name:c.getMessage("BlackCheck"),sub_menu_item:!0,level:50,items:[]};l.items.push({name:c.getMessage("Script_Blacklist_Source"),
id:"script_blacklist_type",level:50,option:!0,select:[{name:c.getMessage("Disabled"),value:"off"},{name:c.getMessage("Server_And_Manual"),value:"server"},{name:c.getMessage("Only_Manual"),value:"only_manual"}],value:h.values.script_blacklist_type});l.items.push({name:c.getMessage("Blacklist_Severity"),id:"script_blacklist_severity",level:50,option:!0,select:[{name:c.getMessage("severity_1"),value:1},{name:c.getMessage("severity_2"),value:2},{name:c.getMessage("severity_3"),value:3},{name:c.getMessage("severity_4"),
value:4},{name:c.getMessage("severity_5"),value:5},{name:c.getMessage("severity_6"),value:6},{name:c.getMessage("severity_7"),value:7},{name:c.getMessage("severity_8"),value:8},{name:c.getMessage("severity_9"),value:9},{name:c.getMessage("severity_10"),value:10}],value:h.values.script_blacklist_severity});l.items.push({name:c.getMessage("Manual_Script_Blacklist"),id:"require_blacklist",level:50,option:!0,input:!0,array:!0,value:h.values.require_blacklist,desc:""});if(q.OPTIONS.CAN_DOWNLOAD){var v=
!1;p={};x.map("exe sh crx com bat scr".split(" "),function(a){return"name."+a}).forEach(function(a){v|=I.is_whitelisted(a)});v&&(p={image:"critical",msg:c.getMessage("Your_whitelist_seems_to_include_executable_files_This_means_your_userscripts_may_download_malware_or_spyware_to_your_harddisk_")});r={name:c.getMessage("Downloads")+" BETA",sub_menu_item:!0,level:50,items:[]};r.items.push({name:c.getMessage("Download_Mode"),id:"downloads_mode",level:50,option:!0,select:x.select([{name:c.getMessage("Default"),
value:I.staticVars.DEFAULT},{name:c.getMessage("Disabled"),value:I.staticVars.OFF},{name:c.getMessage("Native"),value:I.staticVars.NATIVE},{name:c.getMessage("Browser_API"),value:rea.downloads.supported?I.staticVars.CHROME:null}],function(a){return a.value}),value:h.values.downloads_mode,desc:c.getMessage("The_Browser_API_mode_requires_a_special_permission_")});r.items.push({name:c.getMessage("Whitelisted_File_Extensions"),id:"downloads_extension_whitelist",level:50,option:!0,input:!0,array:!0,value:h.values.downloads_extension_whitelist,
desc:c.getMessage("Only_files_with_these_extensions_can_be_saved_to_the_harddisk_Be_careful_to_not_allow_file_extensions_that_represent_executables_at_your_operating_system_"),validation:p})}n={name:c.getMessage("Experimental"),sub_menu_item:!0,level:80,items:[]};q.RUNTIME.FAST_EXEC_SUPPORT&&(p="fast"==h.values.runtime_inject_mode?{image:"critical",msg:"This might cause higher CPU usage!"}:{},n.items.push({name:c.getMessage("Inject_Mode"),id:"runtime_inject_mode",level:80,option:!0,select:[{name:c.getMessage("Default"),
value:"default"},{name:c.getMessage("Fast"),value:"fast"},{name:c.getMessage("Normal"),value:"normal"}],value:h.values.runtime_inject_mode,validation:p}));n.items.push({name:c.getMessage("strict_mode"),id:"runtime_strict_mode",level:80,option:!0,select:[{name:c.getMessage("Default"),value:"byscript"},{name:c.getMessage("Always"),value:"on"},{name:c.getMessage("Disabled"),value:"off"}],value:h.values.runtime_strict_mode});p={name:c.getMessage("Userscripts"),sub_menu_item:!0,level:80,items:[]};p.items.push({name:c.getMessage("Script_URL_detection"),
id:"scriptUrlDetection",level:80,option:!0,select:[{name:c.getMessage("Auto"),value:"auto"},{name:c.getMessage("Disabled"),value:"manual"}],value:h.values.scriptUrlDetection});p.items.push({name:c.getMessage("New_script_template_"),id:"script_templates",level:80,option:!0,input:!0,array:!0,named:!0,value:h.values.script_templates});t={name:c.getMessage("Reset_Section"),sub_menu_item:!0,level:50,items:[]};t.items.push({name:c.getMessage("Restart_Tampermonkey"),id:"reset_simple",level:50,button:!0,
reload:!0,value:0,warning:c.getMessage("This_will_restart_Tampermonkey_Ok_")});t.items.push({name:c.getMessage("Factory_Reset"),id:"reset_factory",level:80,button:!0,reload:!0,value:0,warning:c.getMessage("This_will_remove_all_scripts_and_reset_all_settings_Ok_")});q.OPTIONS.HAS_TESLA&&t.items.push({name:c.getMessage("Chrome_Sync_Reset"),id:"reset_chrome_sync",level:80,button:!0,reload:!0,value:0,warning:c.getMessage("This_will_remove_all_stored_data_from_google_sync_Ok_")});fa&&t.items.push({name:"Install Tests",
id:"install_tests",level:80,button:!0,reload:!1,ignore:!0,value:0,warning:"This will install a lot of test scripts!"});return[e,b,a,d,k,void 0,u,m,void 0,g,f,l,r,p,n,t].filter(function(a){return!!a})}}}(),U=function(){return{create:function(e,w){e=e||"";w=w||{};var g=function(b){return m.onebyone(b).fail(function(){n.warn("tree: wait failed!")}).then(function(a){return a.filter(function(a){return a})})},k=function(b,a){for(var c=b.replace(/\.$/,"").split("."),e=d;c.length;){var g=c.shift();if(e[g]){if("function"===
typeof e[g])return function(){return e[g](w,!a)};e=e[g];c.length||c.unshift("root")}else return n.warn("tree: unable to find",b,w),function(){return m.Pledge([])}}n.warn("tree: unable to find",b,w);return function(){return m.Pledge([])}},d={actions:{root:function(){var b=m();rea.tabs.getSelected(null,function(a){w.tab=a;a=g([k("actions.general"),k("actions.scripts"),k("actions.commands")]);b.consume(a)});return b.promise()},general:function(){var b=w.tab,a=b?b.url:null,d=a&&4<a.length&&""==a.substr(0,
4).replace(/file|http/,"")?a:"",b=[],e={name:"enabled",sub_menu_item:!0,pos:"top",items:[]};e.items.push({name:c.getMessage("Enabled"),display:h.values.enabled?null:"greyed",id:"enabled",button:!0,reload:!0,enabler:!0});b.push(e);"manual"==h.values.scriptUrlDetection&&ka.isScriptUrl(a)&&e.items.push({name:c.getMessage("Install_this_script"),image:"script_download",id:"installFromUrl",data:a,button:!0,reload:!0});a={name:"about",sub_menu_item:!0,pos:"bottom",items:[]};a.items.push({name:c.getMessage("Dashboard"),
image:"utilities",url:rea.extension.getURL("options.html")+"#"+["url="+G.Base64.encode(d),"nav=dashboard"].join("&"),newtab:!0});d="version="+rea.extension.manifest.version+"&ext="+rea.runtime.short_id;a.items.push({image:"info",urls:[{name:" "+c.getMessage("Help"),url:"http://tampermonkey.net/faq.php?"+d,newtab:!0},{name:" "+c.getMessage("Changelog"),url:"http://tampermonkey.net/changelog.php?"+d,newtab:!0}]});b.push(a);return m.Pledge(b)},scripts:function(){var b=w.tab,a=b?b.url:null,d=[],e=a&&
4<a.length&&""==a.substr(0,4).replace(/file|http/,"")?a:"",g,k={name:"scripts",sub_menu_item:!0,pos:"center",items:[]},b=v.getUniqueScriptsForTab(b),n=da.getContexters(0,null),b=na([].concat(b).concat(n)),t;"position"!=h.values.action_menu_scripts_sort&&("name"==h.values.action_menu_scripts_sort?t=function(a,b){return a.name.toLowerCase()<b.name.toLowerCase()?-1:a.name.toLowerCase()>b.name.toLowerCase()?1:0}:"enabled"==h.values.action_menu_scripts_sort&&(t=function(a,b){return b.enabled-a.enabled}));
h.values.action_menu_scripts_hide_disabled&&(b=b.filter(function(a){return a.enabled}));t&&b.sort(t);!h.values.action_menu_scripts_hide_disabled&&2<Math.min(h.values.action_menu_columns,q.ACTIONMENU.COLUMNS)?(g={name:"scripts_right",sub_menu_item:!0,pos:"right",items:[]},b.forEach(function(a){(a.enabled?k:g).items.push(a)}),d.push(k),g.items.length&&d.push(g)):(g=k,k.items=k.items.concat(b),d.push(k));h.values.enabled&&!b.length&&a&&(W.isAllowed(a)?k.items.push({name:c.getMessage("No_script_is_running"),
image:"info"}):k.items.push({name:c.getMessage("This_page_is_blacklisted_at_the_security_settings"),image:"critical"}));a=c.getLocale();h.values.enabled&&("3"==h.values.action_menu_columns||100>h.values.configMode||!b.length)&&(b.length?(t={name:"scripts_new",sub_menu_item:!0,pos:"center",items:[]},d.push(t)):t=k,t.items.push({name:c.getMessage("Get_new_scripts___"),image:"script_download",url:"http://tampermonkey.net/scripts.php"+(a?"?locale="+a:""),newtab:!0}),t.items.push({name:c.getMessage("Add_new_script___"),
image:"script_add",url:rea.extension.getURL("options.html")+"#url="+G.Base64.encode(e)+"&nav=new-user-script",newtab:!0}));return m.Pledge(d)},commands:function(){var b=w.tab,a=[],d=c.getLocale(),e={name:"commands",id:"commands",sub_menu_item:!0,pos:"left",items:[]},g=b.id,b=[],g=null==g||void 0==g?aa.list():aa.listByTabId(g),k;for(k in g)if(g.hasOwnProperty(k)){var n=g[k];b.push({name:n.name,id:n.id,accessKey:n.accessKey,image:"menu_cmd",menucmd:!0})}b.length&&(e.items=b);e.items.push({name:c.getMessage("Check_for_userscripts_updates"),
id:"run_script_updates",button:!0,image:"update"});80<=h.values.configMode&&e.items.push({name:c.getMessage("Report_a_bug"),image:"bug",url:"http://tampermonkey.net/bug",newtab:!0});e.items.push({name:c.getMessage("Please_consider_a_contribution"),image:"contrib",url:"http://tampermonkey.net/contrib.php"+(d?"?locale="+d:""),newtab:!0});a.push(e);return m.Pledge(a)}},options:{root:function(){return g([k("options.general"),k("options.verification"),k("options.scripts"),k("options.settings")])},general:function(){var b=
[];b.push({name:"Version",id:null,version:!0,value:rea.extension.manifest.version});rea.extension.inIncognitoContext&&"temporary"==h.values.incognito_mode&&b.push({globalhint:!0,image:"critical",value:c.getMessage("All_modifications_are_only_kept_until_this_incognito_session_is_closed_")});return m.Pledge(b)},verification:function(){var b=[];ga.getWarnings().forEach(function(a){b.push({globalhint:!0,image:"critical",value:a.text,description:a.description,info_url:a.url})});return m.Pledge(b)},scripts:{root:function(b,
a){var d=m(),e={name:c.getMessage("Installed_userscripts"),main_menu_item:!0,scriptTab:!0,id:"dashboard"};(function(){if(b.complete||!a)return g(x.map(["options.scripts.natives","options.scripts.userscripts","options.scripts.new"],function(a){return k(a)}));e.referrer="options.scripts";e.partial=!0;return g([k("options.scripts.new")])})().done(function(a){e.items=a;d.resolve([e])}).fail(d.reject);return d.promise()},"new":function(){var b=[];b.push({name:c.getMessage("New_userscript"),id:null,image:"script_add",
icon:rea.extension.getURL("images/txt.png"),nnew:!0,uuid:"new-user-script",position:-1,positionof:q.RUNTIME.MAX_SCRIPTS,enabled:!0,userscript:!0});return m.Pledge(b)},natives:function(){var b=[],a=m();L.getAllUserscripts().always(function(d){d=d||[];d.forEach(function(a){b.push({name:a.name,uuid:a.id,icon:a.icon,code:null,position:0,positionof:q.RUNTIME.MAX_SCRIPTS,enabled:a.enabled,version:a.version,description:a.description,nativeScript:!0})});a.resolve(b)});return a.promise()},userscripts:{root:function(b,
a){var d=b.complete||!a?null:"options.scripts.userscripts.source",d=na(v.determineScriptsToRun(null),!0,d),e=d.length,g=c.getLocale();d.push({name:c.getMessage("No_script_is_installed"),image:"info",visible:!e});d.push({name:c.getMessage("Get_some_scripts___"),image:"edit_add",url:"http://tampermonkey.net/scripts.php"+(g?"?locale="+g:""),newtab:!0,visible:!e});return m.Pledge(d)},source:function(b){if(!b.uuid)return m.Pledge([]);b=A.getByUid(b.uuid);if(b.script&&b.cond)return b=h.values.showFixedSrc?
ja.mkCompat(b.script.textContent,b.script,"off"!=h.values.runtime_strict_mode):b.script.textContent,m.Pledge([b]);n.warn("tree: unable to process ",b);return m.Breach()}}},settings:function(b,a){var d=m(),e={name:c.getMessage("Settings"),main_menu_item:!0,id:"settings",selected_default:!0},g;b.complete||!a?g=m.Pledge(Ea.create()):(e.referrer="options.settings",g=m.Pledge());g.done(function(a){e.items=a;d.resolve([e])}).fail(d.reject);return d.promise()}}};n.debug("tree: loading",e,w);return k(e,!0)()}}}(),
na=function(c,m,g){var k=[],d=new y.Script;["author","copyright"].forEach(function(b){d[b]=!1});Object.keys(c).forEach(function(b){var a=c[b],f;if(m){f={};var l=["textContent","requires","resources"];Object.keys(d).forEach(function(b){-1==l.indexOf(b)&&(x.toType(d[b]),f[b]=a[b])});g?(f.referrer=g,f.length=a.textContent.length):f.code=a.textContent;["requires","resources"].forEach(function(b){f[b]=x.map(a[b],function(b){var d=b.url||B.sanitize(b.unsafe_url,b.abs_url),c=N.getElement(a.uuid,d),e=0,f=
null,g=null;c&&c.data&&(c.data.content&&(e=c.data.content.length),g=c.data.sri,f=c.ts);return{display_url:b.url||b.unsafe_url,url:d,data:{length:e},sri:g,ts:f}})});f.origin=v.determineOrigin(a);f.contexter=v.isContexter(a);f.temp_connects=ea.getSessionConnects(a.uuid)}else f={name:a.name,uuid:a.uuid,system:a.system,support:!!a.supportURL,origin:!!v.determineOrigin(a),contexter:v.isContexter(a),enabled:a.enabled,position:a.position};f.blacklisted=a.evilness>=h.values.script_blacklist_severity;a.evilness&&
(f.warnings=Q.getWarningsFor(v.determineSourceURL(a)));f.file_url=a.downloadURL||a.fileURL;f.positionof=c.length;f.userscript=!0;a.icon64||a.icon||(f.icon64=rea.extension.getURL("images/txt.png"));a.options&&Object.keys(d.options).forEach(function(b){f[b]=a.options[b]});k.push(f)});return k},oa={copy:function(c){var h=document.createElement("iframe"),g=document.body||document.documentElement||document;g.appendChild(h);try{h.contentDocument.designMode="on","html"==c.type?(h.setAttribute("sandbox",
"allow-same-origin"),h.contentDocument.documentElement.innerHTML=c.content,h.contentDocument.execCommand("selectAll",!1,null)):h.contentDocument.oncopy=function(g){g.clipboardData.setData(c.mimetype||"text/plain",c.content);g.preventDefault()},h.contentDocument.execCommand("copy",!1,null),h.contentDocument.designMode="off"}catch(k){n.warn("bg: clipboard Error: "+k.message)}g.removeChild(h);h=null}};clip=oa;var T={run:function(c,h){var g=1,k=function(){0==--g&&(h&&h(),rea.page.reload())};if("config"==
c){var d=r.listValues();Object.keys(d).forEach(function(b){b=d[b];-1==b.search(q.CONSTANTS.PREFIX.SCRIPT)&&-1==b.search(q.CONSTANTS.PREFIX.COND)&&-1==b.search(q.CONSTANTS.PREFIX.STORE)&&-1==b.search(q.CONSTANTS.PREFIX.META)&&(g++,r.deleteValue(b).always(k))})}else"factory"==c&&(g++,I.remove_permission().done(k),g++,r.factoryReset().always(k));k()},reset:function(c){T.run(null,c)},factoryReset:function(c){T.run("factory",c)},configReset:function(c){T.run("config",c)}},R=function(){var e=function(){rea.runtime.lastError&&
void 0},m={init:function(){m.setIcon();var c=h.values.appearance_badge_color||"#ee3131";"#"!==c[0]&&(c="#"+c);rea.browserAction.setBadgeBackgroundColor({color:c})},setIcon:function(g){var k,d;d=null;var b=k=!1;void 0===g||C.get.empty(g)||(k=C.get.blocker(g),b=C.get.forbidden(g));b?(k="_forbidden",d=c.getMessage("At_least_one_part_of_this_page_is_listed_at_the_forbidden_pages_setting_")):k?(k="_blocker",d=c.getMessage("Some_scripts_might_be_blocked_by_the_javascript_settings_for_this_page_or_a_script_blocker_")):
k=h.values.enabled&&void 0!==g?"":"_grey";n.debug("badge: set icon "+k);k={path:rea.extension.getURL("images/icon"+k+".png")};d={title:d?d:rea.extension.manifest.name};null!=g&&(k.tabId=g,d.tabId=g);try{rea.browserAction.setIcon(k,e),rea.browserAction.setTitle(d)}catch(a){n.warn("bg: ERROR while setIcon! "+a.message)}},setBadge:function(c){var e=0;"off"==h.values.appearance_badges?e=0:"running"==h.values.appearance_badges?c&&!C.get.empty(c)&&(e=C.get.stats(c).running):"running_unique"==h.values.appearance_badges?
c&&!C.get.empty(c)&&(e=C.get.stats(c,!0).unique):"disabled"==h.values.appearance_badges&&c&&!C.get.empty(c)&&(e=C.get.stats(c).disabled);n.debug("badge: set "+e);e?rea.browserAction.setBadgeText({text:e.toString(),tabId:c}):rea.browserAction.setBadgeText({text:"",tabId:c})}};return m}(),Z=function(){var c=null,h={init:function(){c=r.getValue(q.CONSTANTS.STORAGE.BEGGING,null);if(!c){c={};var g=Date.now(),k=g;x.each(v.determineScriptsToRun(null),function(d){d.lastUpdated&&d.lastUpdated<k&&(k=d.lastUpdated)});
k!==g?(n.debug("beg: first action found at "+(new Date(k)).toISOString()),c.first_run={type:"from_script",ts:k}):c.first_run={type:"from_init",ts:g};h.save()}},save:function(){r.setValue(q.CONSTANTS.STORAGE.BEGGING,c)},needed:function(){var g=Date.now(),h=c.first_run?c.first_run.ts+12096E5<g:!0,d=!c.hide,b=!c.contributed,g=c.later?c.later.ts+12096E5<g:!0;return!q.RUNTIME.DOLPHIN&&h&&d&&b&&g},clicked:function(c,e,d){K.tG("clicked",c,e+d)},dialog:{shown:function(g){var k=Date.now();c.dialog={ts:k,extra:g};
h.save();K.tG("dialog")}},button:function(){var g={};["contributed","later","hide"].forEach(function(k){g[k]=function(d){var b=Date.now();c[k]={ts:b,extra:d};h.save();K.tG("button",k)}});return g}()};return h}(),ha=function(){var c=function(a,b){n.debug(a,b);if(b&&a.menuItemId){var d=A.getByUid(a.menuItemId);d&&d.script?ua.bundle({url:a.frameUrl||a.pageUrl||"<unknown>"},d.script,!0).then(function(d){var c=m();d.method="executeScript";a.frameUrl?d.url=B.woHash(a.frameUrl):d.topframe=!0;rea.tabs.sendMessage(b.id,
d,c.resolve);return c.promise()}):n.debug("ctxm: unable to find script "+a.menuItemId,a,b)}},h=[],g=null,k=!1,d=function(a){var b=[];x.each(a,function(a){var d=m();rea.contextMenus.create({id:a.uuid,contexts:["all"],parentId:g,title:a.name,type:"normal",documentUrlPatterns:["http://*/*","https://*/*","file://*/*"]},function(){d.resolve()});h.push(a.uuid);b.push(d.promise())});return m.when(b)},b=function(){var a=m();rea.contextMenus.removeAll(function(){g=null;a.resolve()});return a.promise()},a=
function(){var a=m();b().then(function(){g=rea.contextMenus.create({contexts:["all"],title:"Tampermonkey",type:"normal",documentUrlPatterns:["http://*/*","https://*/*","file://*/*"]},function(){a.resolve()})});return a.promise()},f=function(){var c=da.getContexters(0,null);if(c.length){var e;e=g?m.Pledge():a();return e.then(function(){return d(c)})}return b().then(l.clean)},l={init:function(){rea.contextMenus.supported&&(l.clean().then(f).then(function(){k=!0}),rea.contextMenus.onClicked.addListener(c))},
clean:function(){var a=m();h.forEach(function(a){rea.contextMenus.remove(a)});h=[];a.resolve();return a.promise()},onScriptsChanged:function(){if(rea.contextMenus.supported&&k)return l.clean().then(f)},getContexterCount:function(){return h.length}};return l}(),qa=function(){var c={},m={},g=("TM_"+x.createUUID().substr(0,5)).toLowerCase(),k=["x-webkit-csp","x-content-security-policy","content-security-policy"],d={getPrefix:function(){return g},onBeforeSendHeaders_xml:function(b){var a=[],d=b.requestHeaders||
[],c,e,h={},k=new RegExp("^"+g),d=d.filter(function(d){if(d.name&&0==d.name.search(k))e=d.name.replace(k,""),h[e.toLowerCase()]=!0,"internal"==e?m[b.requestId]=d.value:a.push({name:e,value:d.value}),c=!0;else return!0});if(c)return{requestHeaders:d.filter(function(a){return!a.name||!h[a.name.toLowerCase()]}).concat(a)}},onBeforeRequest_main_frame:function(b){if(D.late){if(C.events.reset(b.tabId,!0),0<b.tabId&&"POST"!=b.method&&"auto"==h.values.scriptUrlDetection&&ka.isScriptUrl(b.url))return v.installFromUrl(b.url,
{},{silent_fail:!0}).fail(function(a){n.info("webRequest: user script detected @ "+b.url+" was invalid",a?a.messages:"");rea.tabs.update(b.tabId,{url:b.url+"#bypass=true"},function(){})}).done(function(){q.RUNTIME.EDGE&&rea.tabs.query({windowType:"normal"},function(a){a.forEach(function(a){a.id===b.tabId&&rea.tabs.update(a.id,{url:a.url},function(){})})})}),q.RUNTIME.EDGE?{cancel:!0}:{redirectUrl:"javascript:history.back()"}}else D.registerLateCallback(function(){d.onBeforeRequest_main_frame(b)})},
onHeadersReceived_frame_xml:function(b){if(D.late){var a=b.responseHeaders||[];if("xmlhttprequest"==b.type){var f,g;(f=m[b.requestId])&&delete m[b.requestId];(g=c[b.requestId])&&delete c[b.requestId];if(f&&g)return a.push({name:"TM-finalURL"+rea.runtime.short_id,value:g}),{responseHeaders:a}}else{var n,r,u,t=q.OPTIONS.HAS_CSP&&"yes"==h.values.webrequest_fixCSP;a.forEach(function(a){a.name&&a.value&&(a=a.name.toLowerCase(),t&&-1!=k.indexOf(a)?u=!0:"location"==a&&(r=!0))});if(!r&&C.events.response(b.tabId,
b.frameId,b.url)){if((q.RUNTIME.EXEC_SCRIPT_SUPPORT||q.RUNTIME.FAST_EXEC_SUPPORT&&-1!=["default","fast"].indexOf(h.values.runtime_inject_mode))&&(f=C.events.run(b.tabId,b.frameId,null,b.url))){var v=da.answer(f,b.url);if(q.RUNTIME.EXEC_SCRIPT_SUPPORT)rea.tabs.executeScript(b.tabId,{frameId:b.frameId,runAt:"document_start",code:"debugger; window.tm_info = "+JSON.stringify(v)});else{var x=5,y=function(){C.get.exec(b.tabId,b.frameId)||(v.method="fastExec",rea.tabs.sendMessage(b.tabId,v,{frameId:b.frameId},
function(a){var d=rea.runtime.lastError;d&&!a&&0<--x?C.get.exec(b.tabId,b.frameId)||y():d||a&&(C.get.exec(b.tabId,b.frameId)||a.late||C.events.exec(b.tabId,b.frameId,b.url))}))};window.setTimeout(y,h.values.runtime_inject_delay)}}if(u&&(a.forEach(function(b,d){if(b.name&&b.value){var c=b.name.toLowerCase();if(-1!=k.indexOf(c)){var e=!1,f,g,c=b.value.split(";").map(function(a,b){var d=a.trim();if(0===d.search(/^script-src /)){f=!0;var c=-1!=d.search(/'unsafe-eval'/),h=-1!=d.search(/'none'/);if(!c||
h)return n=e=!0,d.replace(/script-src /,"script-src 'unsafe-eval' ").replace(/ 'none'/,"")}else 0===d.search(/^default-src /)&&(g={i:b,v:d});return d});g&&!f&&(c.splice(g.i+1,0,g.v.replace(/default-src /,"script-src 'unsafe-eval' ").replace(/ 'none'/,"")),n=e=!0);a[d]={name:b.name,value:e?c.join(";"):b.value}}}}),n))return{responseHeaders:a}}}}else D.registerLateCallback(function(){d.onHeadersReceived_frame_xml(b)})},onBeforeRedirect_xml:function(b){c[b.requestId]=b.redirectUrl},onResponseStarted_frame:function(b){D.late?
b.fromCache&&C.events.response(b.tabId,b.frameId,b.url):D.registerLateCallback(function(){d.onResponseStarted_frame(b)})},onErrorOccurredListener_main_frame:function(){var b=/ERR_NAME_NOT_RESOLVED/,a=/^([a-z0-9][a-z0-9\-]*[a-z0-9]\.{0,3})*(\.[a-z0-9\-]{2,15})+$/i,d=x.getDebouncer(3E5);return function(c){var e,g;!D.late&&-1===["gcal"].indexOf(rea.runtime.short_id)&&!q.RUNTIME.EDGE&&"http"===c.url.substr(0,4)&&b.exec(c.error)&&(e=B.woPath(c.url).replace(/https?:\/\//,""))&&a.exec(e)&&!d.is(e,!0)&&(g=
v.regexify({inc:["*.tld/*"]}))&&v.validUrl(c.url,g)&&(g=C.events.response(c.tabId,c.frameId||0,c.url),K.tN(e,c.error,g));C.events.reset(c.tabId,!0)}}(),init:function(b){try{var a=q.RUNTIME.EDGE?["http://*/*","https://*/*"]:["<all_urls>"];b?(rea.webRequest.onBeforeRequest.addListener(d.onBeforeRequest_main_frame,{urls:a,types:["main_frame"]},["blocking"]),rea.webRequest.onHeadersReceived.addListener(d.onHeadersReceived_frame_xml,{urls:a,types:["main_frame","sub_frame","xmlhttprequest"]},["blocking",
"responseHeaders"]),q.RUNTIME.WEBREQUEST_XHR_SUPPORT&&rea.webRequest.onBeforeRedirect.addListener(d.onBeforeRedirect_xml,{urls:a,types:["xmlhttprequest"]},[]),rea.webRequest.onResponseStarted.addListener(d.onResponseStarted_frame,{urls:a,types:["main_frame","sub_frame"]},[]),rea.webRequest.onErrorOccurred.addListener(d.onErrorOccurredListener_main_frame,{urls:a,types:["main_frame"]})):"no"!=h.values.webrequest_modHeaders&&rea.webRequest.onBeforeSendHeaders.addListener(d.onBeforeSendHeaders_xml,{urls:a,
types:["xmlhttprequest"]},["blocking","requestHeaders"]);rea.webRequest.handlerBehaviorChanged()}catch(c){n.warn("webRequest: error initializings",c.message)}}};return d}(),Fa=function(){var c=function(c){C.events.commited(c.tabId,c.frameId,c.url)};return{init:function(){rea.webNavigation.supported&&rea.webNavigation.onCommitted.addListener(c)}}}(),D={late:!1,callbacks:[],init:function(){},registerLateCallback:function(c){n.debug("toea: register callback");D.callbacks.push(c)},setReady:function(){n.debug("toea: run "+
D.callbacks.length+" callbacks");D.late=!0;for(var c=0;c<D.callbacks.length;c++)D.callbacks[c]();D.callbacks=[]}},Ga=function(){var c=!1,h=null,g=function(){c||(n.debug("Unloader.onbeforeunload()"),h&&h(),c=!0)};return{init:function(c){h=c;window.addEventListener("beforeunload",g,!1)}}}(),Aa=function(){var e=rea.extension.manifest.version,w=null,g=!1,k=!1,d=function(){if(D.late){var a="version="+e+"&ext="+rea.runtime.short_id+"&updated=true",b;g?(b="http://tampermonkey.net/installed.php?"+a,k=!0):
(a+="&old="+w,b="http://tampermonkey.net/changelog.php?"+a);"off"!=h.values.notification_showUpdate&&("notification"==h.values.notification_showUpdate?P.showUpdate(c.getMessage("Updated_to__0version0",e),c.getMessage("Click_here_to_see_the_recent_changes"),rea.extension.getURL("images/icon128.png"),function(a){a.clicked&&rea.tabs.create({url:b},function(){})}):"changelog"==h.values.notification_showUpdate&&(k||(b+="&intr=true"),k=!0,rea.tabs.create({url:b,active:k},function(){})))}else D.registerLateCallback(d)},
b=function(){var a=null,b,d=m(),c=function(){b&&(b=null,d.resolve(!!a))};b=window.setTimeout(c,300);rea.idle.queryState(q.MISC.IDLE_TIMEOUT,function(b){a="active"==b;c()});return d.promise()},a=function(b){D.late?(n.debug("upd: onInstalled",b),b||(b={reason:"mandatory_argument_is_not_set"}),"chrome_update"==b.reason?K.tB({updated:!0}):"install"!=b.reason&&"update"!=b.reason||u.scheduleNotification(b.previousVersion,"install"==b.reason)):D.registerLateCallback(function(){a(b)})},f=function(){var a=
m(),b=function(){var b=Date.now(),d=r.getValue(q.CONSTANTS.STORAGE.LAST_START,0),b=Math.round((b-d)/1E3),d=b<=q.MISC.DISTURBANCE_ALLOWED;n.debug("upd: restart?",d,"(",b,"seconds ago)");a.resolve(d)};D.late?b():D.registerLateCallback(b);return a.promise()}(),l=function(){var a=!1,c=!1;b().then(function(a){c=a;return f}).then(function(b){a=b}).always(function(){k=!c||a;d();v=!0})},p=null,v=!1,u={scheduleNotification:function(a,b){v||(w=a,g|=b,p&&window.clearTimeout(p),p=window.setTimeout(l,1E3))}};
rea.runtime.onInstalled.addListener(a);rea.runtime.onUpdateAvailable.addListener(function(a){n.info("An update to version",a.version,"is available");window.setTimeout(function(){P.show(c.getMessage("Update"),c.getMessage("0name0_0version0_is_available__Please_re_start_your_browser_to_update_",rea.extension.manifest.name,a.version),rea.extension.getURL("images/icon128.png"),6E4)},864E5)});(function(){D.registerLateCallback(function(){r.setValue(q.CONSTANTS.STORAGE.LAST_START,Date.now())})})();return u}(),
Ha=function(c){"toggle-enable"==c&&(h.values.enabled=!h.values.enabled)},pa=function(){var c=[],m=function(d,b,a){D.late?("auto"==h.values.scriptUrlDetection&&ka.isScriptUrl(a.url)&&v.installFromUrl(a.url),a.url?"loading"==b.status?C.events.loading(a.id,0,a.url):"complete"==b.status&&C.events.complete(a.id,0,a.url):n.warn("tabUpdates: no tab url set! ",a),c.forEach(function(d){d({reason:"updated",status:b.status},a)})):window.setTimeout(function(){m(d,b,a)},100)},g=function(d,b){V[d]&&(V[d].onClose(),
delete V[d]);C.events.remove(d);c.forEach(function(a){a({reason:"removed"},{id:d})})},k=function(d,b){g(b,{});R.setIcon(d);R.setBadge(d);c.forEach(function(a){a({reason:"replaced"},d)})};return{init:function(){rea.tabs.onUpdated.addListener(m);rea.tabs.onRemoved.addListener(g);rea.tabs.onReplaced.addListener(k)},addListener:function(d){c.push(d)},removeListener:function(d){var b;c&&-1<(b=c.indexOf(d))&&c.splice(b,1)}}}(),wa=function(){var c="temporary"==h.values.incognito_mode&&rea.extension.inIncognitoContext;
r.setTemporary(c);c&&(h.values.native_import=!1,h.values.sync_enabled=!1,h.values.scriptUpdateCheckPeriod=0,h.values.sync_type=0,h.values.statistics_enabled=!1)},Ia=function(){n.set(h.values.logLevel);c.setLocale(h.values.i18n);L.setPath(h.values.native_import_path);K.init("bg",rea.extension.manifest.version);K.setEnabled(h.values.statistics_enabled);C.listeners.add.onReset(function(c,e){aa.clearByTabId(c);A.removeStorageListeners({tabid:c},!1);e||R.setIcon(c)});var e=function(c){R.setIcon(c);R.setBadge(c)};
C.listeners.add.onCommited(e);C.listeners.add.onCompleted(e);C.listeners.add.onCompleted(ea.purgeAppeals);C.listeners.add.onRemoved(ea.purgeAppeals);H.init().done(function(c){c&&H.sync()});W.init();Q.init();A.init();e=function(){I.set_mode(h.values.downloads_mode);I.set_whitelist(h.values.downloads_extension_whitelist)};e();I.config_changed_listener=e;Fa.init();ma.init();qa.init();ha.init();Z.init();Y.init()},G,ia,la,ja,y,E,fa;init=function(){D.init();qa.init(!0);pa.init();ta.init();rea.commands.supported&&
rea.commands.onCommand.addListener(Ha);Ga.init(function(){H.finalize()});G=Registry.get("convert");la=Registry.get("xmlhttprequest",qa.getPrefix(),q.RUNTIME.FIREFOX);ia=la.run;ja=Registry.get("compat",q);y=Registry.get("parser");E=Registry.get("syncinfo");fa=Registry.get("test");rea.browserAction.setIcon({path:rea.extension.getURL("images/icon_grey.png")});rea.browserAction.setPopup({popup:"action.html"});rea.browserAction.setTitle({title:"Tampermonkey"});r.init().then(function(){return Ba()}).then(function(){return h.init()}).then(function(){cfgo=
h;wa();Ia();Da();R.init();window.setTimeout(Y.check,1E4);n.debug("Listeners registered!");window.setTimeout(D.setReady,1);if(fa&&Registry.isDevVersion("test")){var c=fa.framework.prepare(v.doSave,q.RUNTIME.BROWSER,q.RUNTIME.BROWSER_VERSION);c&&n.error(c)}})};init()}});
